<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>AIDAY - Dein Tagesplaner</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="AIDAY - Dein persönlicher KI-Coach für tägliche Zielplanung und Produktivität">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AIDAY">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root {
      /* Neue Farbpalette basierend auf dem AIDAY Design */
      --bg-dark: #0f172a;
      --bg-header: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      --bg-light: #f8fafc;
      --bg-card: #ffffff;
      --bg-card-dark: rgba(255, 255, 255, 0.08);
      --bg-card-hover: rgba(255, 255, 255, 0.12);
      --bg-input: #f1f5f9;
      --text: #1e293b;
      --text-light: #ffffff;
      --text-muted: #64748b;
      /* Neue Akzentfarben: Blau-Cyan Gradient */
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.4);
      --accent-2: #22d3ee;
      --accent-2-glow: rgba(34, 211, 238, 0.4);
      --gradient-primary: linear-gradient(135deg, #6366f1 0%, #22d3ee 100%);
      --gradient-primary-hover: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --glass-border: rgba(148, 163, 184, 0.2);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
    }

    /* Dark Mode Theme */
    body.dark-mode {
      --bg-light: #0f172a;
      --bg-card: #1e293b;
      --bg-card-dark: rgba(255, 255, 255, 0.05);
      --bg-card-hover: rgba(255, 255, 255, 0.08);
      --bg-input: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --glass-border: rgba(148, 163, 184, 0.15);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
    }

    /* Dark Mode: Sprechblasen behalten schwarzen Text */
    body.dark-mode .mood-speech-bubble,
    body.dark-mode .energy-speech-bubble,
    body.dark-mode .dashboard-bubble,
    body.dark-mode .motivation-speech-bubble {
      color: #1e293b;
    }

    /* System Preference Dark Mode (wird von JS überschrieben wenn manuell gesetzt) */
    @media (prefers-color-scheme: dark) {
      body:not(.light-mode) {
        --bg-light: #0f172a;
        --bg-card: #1e293b;
        --bg-card-dark: rgba(255, 255, 255, 0.05);
        --bg-card-hover: rgba(255, 255, 255, 0.08);
        --bg-input: #334155;
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --glass-border: rgba(148, 163, 184, 0.15);
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
      }
      /* Sprechblasen behalten schwarzen Text bei System-Präferenz */
      body:not(.light-mode) .mood-speech-bubble,
      body:not(.light-mode) .energy-speech-bubble,
      body:not(.light-mode) .dashboard-bubble,
      body:not(.light-mode) .motivation-speech-bubble {
        color: #1e293b;
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      position: relative;
    }

    /* Background - subtiler Netz-Effekt */
    .bg-animation {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
      background:
        radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(34, 211, 238, 0.06) 0%, transparent 50%);
    }

    /* Container */
    .container {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 100vw;
      margin: 0 auto;
      min-height: 100vh;
      padding-bottom: 20px;
      background: var(--bg-light);
      overflow-x: hidden;
    }

    /* Padding für nicht-Dashboard Screens */
    .container > .screen:not(#dashboardScreen):not(#loadingScreen) {
      padding: 12px 28px;
    }

    /* App Layout */
    .app-header {
      background: var(--bg-card);
      padding: 12px 28px;
      padding-top: max(12px, env(safe-area-inset-top));
      position: relative;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .app-header-content {
      position: relative;
      z-index: 1;
    }

    .app-header-title {
      color: var(--accent);
      font-size: 24px;
      font-weight: 700;
    }

    /* New Header Bar */
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left {
      flex-shrink: 0;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .header-right {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-email {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .header-logout {
      color: var(--text-muted);
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s;
    }

    .header-logout:hover {
      color: var(--danger);
    }

    .progress-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: var(--gradient-primary);
      border: none;
      border-radius: 25px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 10px var(--accent-glow);
      white-space: nowrap;
    }

    .progress-btn:hover {
      background: var(--gradient-primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    .progress-btn svg {
      width: 16px;
      height: 16px;
      stroke: white;
    }

    .app-body {
      padding: 12px 28px;
      background: var(--bg-light);
    }

    /* Quick Actions */
    .quick-actions {
      margin-bottom: 24px;
    }

    .quick-actions-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-left: 0;
      color: var(--text);
    }

    .quick-actions-grid {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
    }

    .quick-action-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 8px;
      background: var(--bg-card);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--shadow);
    }

    .quick-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .quick-action-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--bg-input);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: var(--accent);
    }

    .quick-action-icon svg {
      color: inherit;
    }

    .quick-action-label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Progress Ring */
    .progress-ring {
      position: relative;
      width: 70px;
      height: 70px;
    }

    .progress-ring svg {
      transform: rotate(-90deg);
    }

    .progress-ring-bg {
      fill: none;
      stroke: var(--bg-input);
      stroke-width: 6;
    }

    .progress-ring-fill {
      fill: none;
      stroke: var(--accent);
      stroke-width: 6;
      stroke-linecap: round;
      stroke-dasharray: 188;
      stroke-dashoffset: 47;
      transition: stroke-dashoffset 0.5s;
    }

    .progress-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      font-weight: 600;
    }

    .progress-ring-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
    }

    /* Header */
    .header {
      display: none; /* Standardmäßig ausgeblendet, via JS gesteuert */
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 16px;
      gap: 12px;
      background: var(--bg-card);
      border-radius: 0 0 20px 20px;
      box-shadow: var(--shadow);
    }

    .header-left {
      flex: 0 0 auto;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
    }

    .logo span {
      color: var(--accent);
    }

    .user-email {
      font-size: 11px;
      color: var(--text-muted);
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: none;
    }

    @media (min-width: 400px) {
      .user-email {
        display: block;
      }
    }

    .logout-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .logout-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    /* Screens */
    .screen {
      display: none;
      position: relative;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      padding-bottom: 16px;
    }

    .screen.active {
      display: block;
      animation: slideIn 0.3s ease forwards;
    }

    .screen.slide-out-left {
      animation: slideOutLeft 0.3s ease forwards;
    }

    .screen.slide-out-right {
      animation: slideOutRight 0.3s ease forwards;
    }

    .screen.slide-in-left {
      animation: slideInLeft 0.3s ease forwards;
    }

    .screen.slide-in-right {
      animation: slideInRight 0.3s ease forwards;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(0); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-100%); }
    }

    @keyframes slideOutRight {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: none;
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    /* Dashboard Cards */
    .dashboard-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .dashboard-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .dashboard-card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .tasks-badge {
      background: var(--accent);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .see-all-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .see-all-btn:hover {
      opacity: 0.7;
    }

    /* Streak Badge Header */
    .streak-badge-header {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-light);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .form-input, .form-textarea {
      width: 100%;
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 15px;
      color: var(--text);
      outline: none;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-input:focus, .form-textarea:focus {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Profile Section Divider */
    .profile-section-divider {
      height: 1px;
      background: var(--glass-border);
      margin: 24px 0;
    }

    .profile-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
    }

    /* Theme Toggle */
    .theme-toggle-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .theme-toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-toggle-btn {
      position: relative;
      width: 56px;
      height: 28px;
      background: var(--bg-input);
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s;
      padding: 0;
    }

    .theme-toggle-btn:hover {
      background: var(--bg-card-hover);
    }

    .theme-toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: var(--bg-card);
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }

    body.dark-mode .theme-toggle-slider {
      transform: translateX(28px);
    }

    .theme-toggle-icon {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
    }

    .theme-toggle-icon svg {
      width: 16px;
      height: 16px;
    }

    .light-icon {
      left: 6px;
      color: var(--warning);
    }

    .dark-icon {
      right: 6px;
      color: var(--accent);
    }

    body:not(.dark-mode) .dark-icon {
      opacity: 0.4;
    }

    body.dark-mode .light-icon {
      opacity: 0.4;
    }

    .theme-toggle-label {
      font-size: 14px;
      color: var(--text-muted);
      min-width: 50px;
    }

    /* Profile Completion Ring */
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 8px;
    }

    .profile-header-text {
      flex: 1;
    }

    .profile-header-text .card-title {
      margin-bottom: 4px;
    }

    .profile-header-text .card-subtitle {
      margin-bottom: 0;
    }

    .profile-completion-ring {
      position: relative;
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      cursor: help;
    }

    .profile-completion-ring svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .profile-ring-bg {
      stroke: var(--bg-input);
    }

    .profile-ring-fill {
      stroke: var(--accent);
      stroke-linecap: round;
      transition: stroke-dasharray 0.5s ease;
    }

    .profile-ring-fill.complete {
      stroke: var(--success);
    }

    .profile-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .profile-completion-hint {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-input);
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      transition: opacity 0.3s;
    }

    .profile-completion-hint.hidden {
      display: none;
    }

    /* Mood Selector */
    .mood-selector {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    .mood-btn {
      width: 56px;
      height: 56px;
      min-width: 56px;
      min-height: 56px;
      max-width: 56px;
      max-height: 56px;
      border-radius: 50%;
      border: 2px solid var(--bg-input);
      background: var(--bg-card);
      font-size: 26px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      flex-shrink: 0;
      aspect-ratio: 1 / 1;
    }

    .mood-btn:hover {
      transform: scale(1.1);
      border-color: var(--accent);
    }

    .mood-btn.selected {
      border-color: var(--accent);
      background: var(--accent-glow);
      transform: scale(1.15);
    }

    /* Energy Slider */
    .energy-slider {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 16px 0;
      position: relative;
    }

    .energy-level {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid var(--bg-input);
      background: var(--bg-card);
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }

    .energy-level:hover {
      border-color: var(--accent);
    }

    .energy-level.selected {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    /* Energy Level Attention Animation */
    .energy-slider.needs-attention .energy-level {
      animation: energyPulse 0.6s ease-in-out;
    }

    .energy-slider.needs-attention .energy-level:nth-child(1) { animation-delay: 0s; }
    .energy-slider.needs-attention .energy-level:nth-child(2) { animation-delay: 0.08s; }
    .energy-slider.needs-attention .energy-level:nth-child(3) { animation-delay: 0.16s; }
    .energy-slider.needs-attention .energy-level:nth-child(4) { animation-delay: 0.24s; }
    .energy-slider.needs-attention .energy-level:nth-child(5) { animation-delay: 0.32s; }

    @keyframes energyPulse {
      0%, 100% { transform: scale(1); border-color: var(--bg-input); }
      25% { transform: scale(1.15); border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
      50% { transform: scale(0.95); }
      75% { transform: scale(1.1); border-color: var(--accent); }
    }

    /* Form Groups with Speech Bubbles */
    .energy-form-group,
    .mood-form-group {
      position: relative;
    }

    @keyframes bubbleShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }

    /* Mood Selection Attention Animation */
    .mood-buttons.needs-attention .mood-btn {
      animation: moodPulse 0.6s ease-in-out;
    }

    .mood-buttons.needs-attention .mood-btn:nth-child(1) { animation-delay: 0s; }
    .mood-buttons.needs-attention .mood-btn:nth-child(2) { animation-delay: 0.08s; }
    .mood-buttons.needs-attention .mood-btn:nth-child(3) { animation-delay: 0.16s; }
    .mood-buttons.needs-attention .mood-btn:nth-child(4) { animation-delay: 0.24s; }
    .mood-buttons.needs-attention .mood-btn:nth-child(5) { animation-delay: 0.32s; }

    @keyframes moodPulse {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.2); box-shadow: 0 0 20px var(--accent-glow); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
    }

    .mood-speech-bubble,
    .energy-speech-bubble {
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      background: white;
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--glass-border);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.4;
    }

    .mood-speech-bubble::after,
    .energy-speech-bubble::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 24px;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 16px solid white;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.05));
    }

    .mood-speech-bubble.show,
    .energy-speech-bubble.show {
      opacity: 1;
      animation: bubbleShake 0.5s ease-in-out, bubbleFadeOut 0.3s ease 2.2s forwards;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 16px 28px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      margin-top: 8px;
      text-align: center;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: #fff;
      border-radius: 30px;
      box-shadow: 0 4px 20px var(--accent-glow);
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .btn-primary:hover {
      background: var(--gradient-primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 30px var(--accent-glow);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid var(--glass-border);
      color: var(--text);
      border-radius: 30px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .btn-secondary:hover {
      background: var(--bg-input);
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-danger {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    /* Progress */
    .progress-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .progress-step {
      flex: 1;
      height: 4px;
      background: var(--glass-border);
      border-radius: 2px;
      transition: all 0.3s;
    }

    .progress-step.active {
      background: var(--accent);
    }

    .progress-step.completed {
      background: var(--success);
    }

    /* Goal Card */
    .goal-number {
      font-size: 12px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
    }

    /* Task List */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-input);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .task-item:hover {
      background: #e5e8ec;
    }

    .task-item.completed {
      background: rgba(16, 185, 129, 0.1);
    }

    .task-item.completed .task-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .task-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.3s;
      font-size: 12px;
      color: white;
    }

    .task-item.completed .task-checkbox {
      background: var(--success);
      border-color: var(--success);
    }

    .task-text {
      flex: 1;
      font-size: 14px;
      cursor: pointer;
      color: var(--text);
    }

    .task-delete-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
      opacity: 0;
      line-height: 1;
    }

    .task-item:hover .task-delete-btn,
    .progress-task-item:hover .task-delete-btn {
      opacity: 1;
    }

    .task-delete-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* Task Arrow for Detail View */
    .task-arrow {
      font-size: 20px;
      color: var(--text-muted);
      padding: 0 4px;
      cursor: pointer;
      flex-shrink: 0;
    }

    /* Task Meta Info (Dauer, beste Zeit) in Liste */
    .task-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .task-meta {
      display: flex;
      gap: 12px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .task-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-item.completed .task-meta {
      opacity: 0.5;
    }

    /* Task Detail Screen */
    .task-detail-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .task-detail-time, .task-detail-duration {
      background: var(--bg-input);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .task-detail-title {
      font-size: 20px;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .task-detail-why {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(34, 211, 238, 0.1));
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .task-detail-why strong {
      display: block;
      margin-bottom: 8px;
      color: var(--accent);
    }

    .task-detail-why p {
      margin: 0;
      line-height: 1.6;
    }

    .task-detail-steps {
      margin-bottom: 24px;
    }

    .task-detail-steps strong {
      display: block;
      margin-bottom: 12px;
    }

    .task-detail-steps ol {
      padding-left: 20px;
      margin: 0;
    }

    .task-detail-steps li {
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .task-detail-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .task-detail-actions .btn {
      flex: 1;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 40px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      opacity: 0.6;
    }

    .empty-state-icon svg {
      color: inherit;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      margin-bottom: 16px;
    }

    .empty-state-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      background: var(--gradient-primary);
      border: none;
      border-radius: 20px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .empty-state-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    /* AI Plan Card */
    .ai-plan-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(34, 211, 238, 0.08));
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-glow);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .plan-section {
      margin-bottom: 16px;
    }

    .plan-section-title {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .plan-steps {
      list-style: none;
    }

    .plan-steps li {
      padding: 8px 0;
      padding-left: 24px;
      position: relative;
      font-size: 14px;
    }

    .plan-steps li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 14px;
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
    }

    /* Review Buttons */
    .review-buttons {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .review-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--glass-border);
      background: transparent;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .review-btn:hover {
      border-color: var(--accent);
    }

    .review-btn.selected-yes {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .review-btn.selected-no {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    /* Streak */
    .streak-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--warning), #f97316);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 20px;
    }

    /* Gamification */
    .gamification-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .gamification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .level-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--gradient-primary);
      padding: 6px 14px;
      border-radius: 20px;
      color: white;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    .level-badge svg {
      width: 18px;
      height: 18px;
    }

    .xp-text {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .xp-bar-container {
      background: var(--bg-input);
      border-radius: 10px;
      height: 12px;
      overflow: hidden;
      position: relative;
    }

    .xp-bar-progress {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 10px;
      transition: width 0.5s ease;
      position: relative;
    }

    .xp-bar-progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 100%);
      border-radius: 10px 10px 0 0;
    }

    .achievements-preview {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .achievement-mini {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-input);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .achievement-mini.earned {
      background: var(--gradient-primary);
      box-shadow: 0 2px 8px var(--accent-glow);
    }

    .achievement-mini.locked {
      opacity: 0.4;
      filter: grayscale(100%);
    }

    .achievement-mini:hover {
      transform: scale(1.1);
    }

    /* Achievement Popup */
    .achievement-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: var(--bg-card);
      border-radius: 20px;
      padding: 32px;
      text-align: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 320px;
      width: 90%;
    }

    .achievement-popup.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .achievement-popup-icon {
      font-size: 64px;
      margin-bottom: 16px;
      animation: achievementBounce 0.6s ease;
    }

    @keyframes achievementBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .achievement-popup-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .achievement-popup-desc {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .achievement-popup-xp {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--gradient-primary);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .achievement-popup-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      font-size: 20px;
    }

    .achievement-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .achievement-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Level Up Animation */
    .level-up-flash {
      animation: levelUpFlash 1s ease;
    }

    @keyframes levelUpFlash {
      0%, 100% { box-shadow: 0 2px 8px var(--accent-glow); }
      50% { box-shadow: 0 0 30px var(--accent-glow), 0 0 60px var(--accent-2-glow); }
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      min-height: 60vh;
    }

    .spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--bg-input);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      color: var(--text);
      font-size: 15px;
      font-weight: 500;
    }

    /* Loading Screen spezifisch */
    #loadingScreen.active {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 0 !important;
    }

    /* Onboarding Modal */
    .onboarding-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .onboarding-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .onboarding-modal {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 400px;
      width: 100%;
      position: relative;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .onboarding-skip {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
    }

    .onboarding-skip:hover {
      color: var(--text);
    }

    .onboarding-slides {
      position: relative;
      min-height: 280px;
    }

    .onboarding-slide {
      display: none;
      text-align: center;
      animation: fadeIn 0.3s ease;
    }

    .onboarding-slide.active {
      display: block;
    }

    .onboarding-icon {
      margin-bottom: 24px;
    }

    .onboarding-icon svg {
      filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.3));
    }

    .onboarding-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }

    .onboarding-text {
      font-size: 15px;
      line-height: 1.8;
      color: var(--text-muted);
    }

    .onboarding-text strong {
      color: var(--text);
    }

    .onboarding-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 24px 0;
    }

    .onboarding-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--bg-input);
      cursor: pointer;
      transition: all 0.3s;
    }

    .onboarding-dot.active {
      background: var(--accent);
      width: 24px;
      border-radius: 4px;
    }

    .onboarding-actions {
      display: flex;
      gap: 12px;
      justify-content: space-between;
    }

    .onboarding-prev,
    .onboarding-next {
      flex: 1;
      padding: 14px 24px;
    }

    /* Weekly Report Modal */
    .weekly-report-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .weekly-report-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .weekly-report-modal {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 400px;
      width: 100%;
      position: relative;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.4s ease;
    }

    .weekly-report-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }

    .weekly-report-close:hover {
      color: var(--text);
    }

    .weekly-report-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .weekly-report-icon {
      margin-bottom: 16px;
    }

    .weekly-report-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .weekly-report-subtitle {
      font-size: 14px;
      color: var(--text-muted);
    }

    .weekly-report-stats {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .weekly-stat {
      background: var(--bg-input);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }

    .weekly-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .weekly-stat-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .weekly-stat-bar {
      height: 6px;
      background: var(--glass-border);
      border-radius: 3px;
      margin-top: 12px;
      overflow: hidden;
    }

    .weekly-stat-bar-fill {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .weekly-report-message {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(34, 211, 238, 0.1));
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      font-size: 15px;
      color: var(--text);
      margin-bottom: 24px;
    }

    .weekly-report-btn {
      width: 100%;
    }

    /* Achievements Info Modal */
    .achievements-info-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .achievements-info-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .achievements-info-modal {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 28px 20px;
      max-width: 420px;
      width: 100%;
      position: relative;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.4s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    .achievements-info-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }

    .achievements-info-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .achievements-info-icon {
      margin-bottom: 12px;
    }

    .achievements-info-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .achievements-info-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .xp-info-section,
    .achievements-info-section,
    .level-info-section {
      margin-bottom: 20px;
    }

    .xp-info-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
    }

    .xp-info-table {
      background: var(--bg-input);
      border-radius: 12px;
      overflow: hidden;
    }

    .xp-info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--glass-border);
    }

    .xp-info-row:last-child {
      border-bottom: none;
    }

    .xp-info-row.highlight {
      background: rgba(99, 102, 241, 0.1);
    }

    .xp-info-action {
      font-size: 13px;
      color: var(--text);
    }

    .xp-info-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
    }

    .achievements-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .achievement-info-item {
      background: var(--bg-input);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .achievement-info-icon {
      display: block;
      font-size: 24px;
      margin-bottom: 6px;
    }

    .achievement-info-name {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .achievement-info-desc {
      display: block;
      font-size: 10px;
      color: var(--text-muted);
    }

    .level-info-text {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .level-info-examples {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .level-info-examples span {
      background: var(--bg-input);
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: var(--text);
    }

    .achievements-info-btn {
      width: 100%;
      margin-top: 8px;
    }

    /* Goal Tags */
    .goal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .goal-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      cursor: default;
    }

    .goal-tag.tag-blue { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
    .goal-tag.tag-green { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .goal-tag.tag-red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .goal-tag.tag-yellow { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .goal-tag.tag-purple { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .goal-tag.tag-cyan { background: rgba(34, 211, 238, 0.15); color: #22d3ee; }

    .goal-tag-remove {
      background: transparent;
      border: none;
      color: inherit;
      font-size: 14px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      opacity: 0.6;
    }

    .goal-tag-remove:hover {
      opacity: 1;
    }

    /* Tag Filter Buttons */
    .tag-filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-input);
      border-radius: 12px;
    }

    .tag-filter-btn {
      padding: 6px 14px;
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: var(--bg-card);
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-filter-btn:hover {
      border-color: var(--accent);
    }

    .tag-filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Tag Input für Goal-Detail */
    .tag-input-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }

    .tag-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      background: var(--bg-input);
      color: var(--text);
      font-size: 13px;
    }

    .tag-input::placeholder {
      color: var(--text-muted);
    }

    .tag-add-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-add-btn:hover {
      background: var(--gradient-primary-hover);
    }

    .tag-color-select {
      display: flex;
      gap: 6px;
    }

    .tag-color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-color-option:hover,
    .tag-color-option.selected {
      border-color: var(--text);
      transform: scale(1.1);
    }

    .tag-color-option.color-blue { background: #6366f1; }
    .tag-color-option.color-green { background: #10b981; }
    .tag-color-option.color-red { background: #ef4444; }
    .tag-color-option.color-yellow { background: #f59e0b; }
    .tag-color-option.color-purple { background: #a855f7; }
    .tag-color-option.color-cyan { background: #22d3ee; }

    /* Gamification Info Button */
    .gamification-info-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .gamification-info-btn:hover {
      background: var(--bg-input);
      color: var(--accent);
      border-color: var(--accent);
    }

    /* Blocker Input */
    .blocker-input {
      margin-top: 12px;
      display: none;
    }

    .blocker-input.show {
      display: block;
    }

    /* Navigation */
    .nav-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .nav-buttons .btn {
      flex: 1;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .empty-state-icon svg {
      color: inherit;
    }

    /* Plan Timeline */
    .plan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--glass-border);
    }

    .plan-duration {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .plan-target-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .milestone-timeline {
      position: relative;
      padding-left: 24px;
      margin: 20px 0;
    }

    .milestone-timeline::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--glass-border);
    }

    .milestone-item {
      position: relative;
      padding: 12px 0;
    }

    .milestone-item::before {
      content: '';
      position: absolute;
      left: -24px;
      top: 16px;
      width: 14px;
      height: 14px;
      background: var(--bg-dark);
      border: 2px solid var(--accent);
      border-radius: 50%;
    }

    .milestone-week {
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .milestone-target {
      font-size: 14px;
      font-weight: 500;
    }

    .milestone-metric {
      font-size: 12px;
      color: var(--success);
      margin-top: 2px;
    }

    /* Daily Tasks in Plan */
    .daily-task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .daily-task-item .task-icon {
      width: 32px;
      height: 32px;
      background: var(--success);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
    }

    .daily-task-item .task-icon svg {
      color: inherit;
    }

    .daily-task-item .task-info {
      flex: 1;
    }

    .daily-task-item .task-name {
      font-size: 14px;
      font-weight: 500;
    }

    .daily-task-item .task-duration {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Detailed Task Item (for Plan Screen) */
    .daily-task-item-detailed {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .daily-task-item-detailed .task-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .daily-task-item-detailed .task-icon {
      width: 36px;
      height: 36px;
      min-width: 36px;
      background: var(--success);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .daily-task-item-detailed .task-info {
      flex: 1;
    }

    .daily-task-item-detailed .task-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .daily-task-item-detailed .task-meta {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .daily-task-item-detailed .task-time {
      color: var(--accent);
    }

    .daily-task-item-detailed .task-why {
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .daily-task-item-detailed .task-why strong {
      color: var(--accent);
    }

    .daily-task-item-detailed .task-steps {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--glass-border);
    }

    .daily-task-item-detailed .task-steps-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .daily-task-item-detailed .task-steps-list {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: var(--text);
      line-height: 1.8;
    }

    .daily-task-item-detailed .task-steps-list li {
      margin-bottom: 4px;
    }

    .daily-task-item-detailed .task-steps-list li::marker {
      color: var(--success);
    }

    /* Progress Bar */
    .progress-container {
      margin: 16px 0;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .progress-track {
      height: 8px;
      background: var(--glass-border);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Goal Card with Progress */
    .goal-progress-card {
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .goal-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .goal-progress-title {
      font-size: 15px;
      font-weight: 500;
    }

    .goal-progress-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      background: var(--accent-glow);
      color: var(--accent);
    }

    .goal-days-left {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* Back Button */
    .back-btn {
      display: none;
    }

    /* Footer Back Button */
    .footer-back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 16px 28px;
      margin-top: 24px;
      background: transparent !important;
      border: 2px solid rgba(148, 163, 184, 0.3);
      border-radius: 30px;
      color: var(--text-muted);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.3px;
      backdrop-filter: none;
    }

    .footer-back-btn:hover {
      background: var(--bg-card);
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.15);
    }

    .footer-back-btn:active {
      transform: translateY(0);
    }

    .footer-back-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Delete Goal Button */
    .btn-delete-goal {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 24px;
      margin-top: 32px;
      background: transparent;
      border: 2px solid rgba(239, 68, 68, 0.3);
      border-radius: 30px;
      color: #ef4444;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-delete-goal:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
    }

    .btn-delete-goal:active {
      transform: translateY(0);
    }

    .btn-delete-goal svg {
      width: 18px;
      height: 18px;
    }

    /* Goal Detail Screen */
    .goal-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .goal-detail-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--glass-border);
    }

    .goal-detail-section-title {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .goal-info-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--glass-border);
    }

    .goal-info-item:last-child {
      border-bottom: none;
    }

    .goal-info-label {
      font-size: 12px;
      color: var(--text-muted);
      min-width: 100px;
    }

    .goal-info-value {
      font-size: 14px;
      flex: 1;
    }

    /* Step Item */
    .step-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .step-item.completed {
      opacity: 0.6;
    }

    .step-item.completed .step-text {
      text-decoration: line-through;
    }

    .step-number {
      width: 28px;
      height: 28px;
      background: var(--accent-glow);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      flex-shrink: 0;
    }

    .step-item.completed .step-number {
      background: var(--success);
      color: #fff;
    }

    .step-content {
      flex: 1;
    }

    .step-text {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .step-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Clickable Goal in List */
    .goal-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 8px;
    }

    .goal-list-item:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent);
    }

    .goal-list-icon {
      width: 40px;
      height: 40px;
      background: var(--accent-glow);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .goal-list-content {
      flex: 1;
    }

    .goal-list-title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .goal-list-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .goal-list-arrow {
      color: var(--text-muted);
      font-size: 18px;
    }


    /* Progress Screen Animations */
    .animate-in {
      animation: slideInUp 0.5s ease forwards;
      opacity: 0;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Progress Card */
    .progress-card {
      margin-bottom: 16px;
    }

    .progress-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .progress-card-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .progress-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Today Stats - Circles */
    .today-stats {
      display: flex;
      justify-content: space-around;
      gap: 16px;
    }

    .stat-circle-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .stat-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 12px;
    }

    .stat-emoji {
      font-size: 36px;
      display: none; /* Versteckt, verwenden animiertes Face */
    }

    /* Animated Mood Face */
    .mood-face {
      width: 56px;
      height: 56px;
      position: relative;
    }

    .mood-face-svg {
      width: 100%;
      height: 100%;
    }

    /* Face base circle */
    .face-bg {
      fill: #fbbf24;
      transition: fill 0.3s ease;
    }

    .mood-face.great .face-bg { fill: #fbbf24; }
    .mood-face.good .face-bg { fill: #fcd34d; }
    .mood-face.neutral .face-bg { fill: #fde68a; }
    .mood-face.bad .face-bg { fill: #d1d5db; }
    .mood-face.terrible .face-bg { fill: #9ca3af; }

    /* Eyes */
    .face-eye {
      fill: #1f2937;
      animation: blink 4s infinite;
    }

    .mood-face.great .face-eye {
      animation: blink 3s infinite, happyEyes 2s infinite;
    }

    .mood-face.terrible .face-eye {
      animation: blink 5s infinite;
    }

    @keyframes blink {
      0%, 45%, 55%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.1); }
    }

    @keyframes happyEyes {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.85); }
    }

    /* Eye position fix for animation */
    .eye-left { transform-origin: 35% 40%; }
    .eye-right { transform-origin: 65% 40%; }

    /* Mouth shapes */
    .face-mouth {
      fill: none;
      stroke: #1f2937;
      stroke-width: 2.5;
      stroke-linecap: round;
      transition: d 0.3s ease;
    }

    /* Great - Big smile with animation */
    .mood-face.great .face-mouth {
      animation: smile 2s ease-in-out infinite;
    }

    @keyframes smile {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(1.1); }
    }

    /* Cheeks for happy moods */
    .face-cheek {
      fill: #f87171;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .mood-face.great .face-cheek {
      opacity: 0.4;
      animation: blush 3s ease-in-out infinite;
    }

    .mood-face.good .face-cheek {
      opacity: 0.25;
    }

    @keyframes blush {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.55; }
    }

    /* Tears for terrible mood */
    .face-tear {
      fill: #60a5fa;
      opacity: 0;
    }

    .mood-face.terrible .face-tear {
      opacity: 1;
      animation: tear 2s ease-in-out infinite;
    }

    @keyframes tear {
      0% { transform: translateY(0); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translateY(12px); opacity: 0; }
    }

    /* Eyebrows */
    .face-brow {
      fill: none;
      stroke: #1f2937;
      stroke-width: 2;
      stroke-linecap: round;
      opacity: 0;
    }

    .mood-face.bad .face-brow,
    .mood-face.terrible .face-brow {
      opacity: 1;
    }

    /* Sparkles for great mood */
    .face-sparkle {
      fill: #fbbf24;
      opacity: 0;
    }

    .mood-face.great .face-sparkle {
      opacity: 1;
      animation: sparkle 1.5s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { transform: scale(0.8); opacity: 0.6; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    .sparkle-1 { animation-delay: 0s; }
    .sparkle-2 { animation-delay: 0.5s; }
    .sparkle-3 { animation-delay: 1s; }

    /* Clickable Mood Face */
    .mood-face {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .mood-face:hover {
      transform: scale(1.05);
    }

    .mood-face:active {
      transform: scale(0.95);
    }

    /* Click Animation States */
    .mood-face.clicking {
      pointer-events: none;
    }

    /* GREAT - Dancing Animation */
    .mood-face.great.clicking {
      animation: dance 0.5s ease-in-out 3;
    }

    @keyframes dance {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-10px) rotate(-10deg); }
      50% { transform: translateY(0) rotate(0deg); }
      75% { transform: translateY(-10px) rotate(10deg); }
    }

    /* GOOD - Tongue Out Animation */
    .face-tongue {
      fill: #f87171;
      opacity: 0;
      transform-origin: center top;
      transform: scaleY(0);
    }

    .mood-face.good.clicking .face-tongue {
      opacity: 1;
      animation: tongueOut 1.5s ease-in-out forwards;
    }

    .mood-face.good.clicking {
      animation: laughShake 0.15s ease-in-out 6;
    }

    @keyframes tongueOut {
      0% { transform: scaleY(0); opacity: 0; }
      20% { transform: scaleY(1.2); opacity: 1; }
      40% { transform: scaleY(1); opacity: 1; }
      60% { transform: scaleY(1.1); opacity: 1; }
      80% { transform: scaleY(1); opacity: 1; }
      100% { transform: scaleY(0); opacity: 0; }
    }

    @keyframes laughShake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-3deg); }
      75% { transform: rotate(3deg); }
    }

    /* NEUTRAL - Silly Eye Roll & Wiggle */
    .mood-face.neutral.clicking {
      animation: sillyWiggle 0.3s ease-in-out 4;
    }

    .mood-face.neutral.clicking .face-eye {
      animation: crazyEyes 1.2s ease-in-out forwards !important;
    }

    @keyframes sillyWiggle {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(-5deg) scale(1.1); }
      75% { transform: rotate(5deg) scale(1.1); }
    }

    @keyframes crazyEyes {
      0% { transform: translateX(0); }
      10% { transform: translateX(3px); }
      20% { transform: translateX(-3px); }
      30% { transform: translateX(3px) translateY(-2px); }
      40% { transform: translateX(-3px) translateY(2px); }
      50% { transform: translateX(0) scaleY(0.1); }
      60% { transform: translateX(2px) scaleY(1); }
      70% { transform: translateX(-2px); }
      80% { transform: translateX(0); }
      100% { transform: translateX(0) scaleY(1); }
    }

    /* Stars appear for neutral click */
    .face-star {
      fill: #fbbf24;
      opacity: 0;
    }

    .mood-face.neutral.clicking .face-star {
      animation: starPop 1.2s ease-out forwards;
    }

    @keyframes starPop {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      30% { transform: scale(1.3) rotate(180deg); opacity: 1; }
      60% { transform: scale(1) rotate(360deg); opacity: 1; }
      100% { transform: scale(0) rotate(540deg); opacity: 0; }
    }

    /* BAD - Encouraging wave & heart */
    .face-heart {
      fill: #f87171;
      opacity: 0;
      transform-origin: center;
    }

    .mood-face.bad.clicking {
      animation: encourageWave 0.4s ease-in-out 3;
    }

    .mood-face.bad.clicking .face-heart {
      animation: heartPop 1.2s ease-out forwards;
    }

    .mood-face.bad.clicking .face-mouth {
      animation: sadToSmile 1.2s ease-in-out forwards;
    }

    @keyframes encourageWave {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg); }
      75% { transform: rotate(15deg); }
    }

    @keyframes heartPop {
      0% { transform: scale(0) translateY(0); opacity: 0; }
      30% { transform: scale(1.3) translateY(-5px); opacity: 1; }
      50% { transform: scale(1) translateY(-10px); opacity: 1; }
      70% { transform: scale(1.2) translateY(-15px); opacity: 1; }
      100% { transform: scale(0) translateY(-25px); opacity: 0; }
    }

    @keyframes sadToSmile {
      0%, 20% { d: path("M22 46 Q32 42, 42 46"); }
      40%, 60% { d: path("M22 44 L42 44"); }
      80%, 100% { d: path("M22 46 Q32 42, 42 46"); }
    }

    /* TERRIBLE - Big hug & multiple hearts */
    .mood-face.terrible.clicking {
      animation: hugSqueeze 0.3s ease-in-out 4;
    }

    .mood-face.terrible.clicking .face-heart {
      animation: heartsFloat 1.5s ease-out forwards;
    }

    .mood-face.terrible.clicking .face-tear {
      animation: none !important;
      opacity: 0 !important;
    }

    .mood-face.terrible.clicking .face-mouth {
      animation: terribleToHappy 1.5s ease-in-out forwards;
    }

    .face-hug-arm {
      stroke: #fbbf24;
      stroke-width: 4;
      stroke-linecap: round;
      opacity: 0;
    }

    .mood-face.terrible.clicking .face-hug-arm {
      animation: hugArms 1.5s ease-in-out forwards;
    }

    @keyframes hugSqueeze {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    @keyframes heartsFloat {
      0% { transform: scale(0); opacity: 0; }
      20% { transform: scale(1.2); opacity: 1; }
      40% { transform: scale(1) translateY(-5px); opacity: 1; }
      100% { transform: scale(0.5) translateY(-30px); opacity: 0; }
    }

    @keyframes terribleToHappy {
      0%, 20% { d: path("M22 48 Q32 38, 42 48"); }
      50% { d: path("M22 44 L42 44"); }
      80%, 100% { d: path("M20 42 Q32 50, 44 42"); }
    }

    @keyframes hugArms {
      0% { opacity: 0; transform: scaleX(0); }
      30% { opacity: 1; transform: scaleX(1); }
      70% { opacity: 1; transform: scaleX(1); }
      100% { opacity: 0; transform: scaleX(0); }
    }

    /* Heart positions for multiple hearts */
    .heart-1 { animation-delay: 0s; }
    .heart-2 { animation-delay: 0.2s; }
    .heart-3 { animation-delay: 0.4s; }

    /* Dashboard Bubble Container */
    .dashboard-bubble-container {
      position: relative;
      width: 100%;
      height: 0;
      margin: 0 -16px;
      padding: 0 16px;
    }

    /* Speech Bubble über Emoji (Dashboard) */
    .dashboard-bubble {
      position: absolute;
      top: -45px;
      left: -8px;
      right: -8px;
      background: white;
      color: var(--text-primary);
      padding: 14px 28px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--glass-border);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.4;
    }

    .dashboard-bubble::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 60px;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 16px solid white;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.05));
    }

    .dashboard-bubble.show {
      animation: bubblePopIn 0.3s ease forwards, bubbleFadeOut 0.3s ease 1.7s forwards;
    }

    @keyframes bubblePopIn {
      0% { opacity: 0; transform: translateY(10px) scale(0.8); }
      50% { transform: translateY(-5px) scale(1.05); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes bubbleFadeOut {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-10px) scale(0.8); }
    }

    /* Dashboard bubble is always white - no mood-specific colors */

    /* Motivation Speech Bubble */
    .motivation-speech-bubble {
      position: relative;
      margin-top: 16px;
      transform: scale(0.95);
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
      padding: 16px 20px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      text-align: center;
      box-shadow: 0 8px 32px rgba(6, 182, 212, 0.3);
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
    }

    .motivation-speech-bubble.show {
      opacity: 1;
      max-height: 200px;
      padding: 16px 20px;
      margin-top: 16px;
      transform: scale(1);
      animation: motivationBubbleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .motivation-speech-bubble.hiding {
      animation: motivationBubbleOut 0.4s ease-out forwards;
    }

    @keyframes motivationBubbleIn {
      0% { opacity: 0; max-height: 0; transform: scale(0.9); }
      100% { opacity: 1; max-height: 200px; transform: scale(1); }
    }

    @keyframes motivationBubbleOut {
      0% { opacity: 1; max-height: 200px; transform: scale(1); }
      100% { opacity: 0; max-height: 0; transform: scale(0.9); }
    }

    .motivation-speech-bubble .quote-text {
      font-style: italic;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .motivation-speech-bubble .quote-author {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 600;
    }

    /* Mood-specific variants */
    .motivation-speech-bubble.bad {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
    }

    .motivation-speech-bubble.terrible {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    }

    .motivation-speech-bubble.tasks-reminder {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      box-shadow: 0 8px 32px rgba(245, 158, 11, 0.3);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 14px;
      font-weight: 500;
    }

    /* Energy & Tasks Circle Rings */
    .energy-circle, .tasks-circle {
      background: transparent;
    }

    .energy-ring, .tasks-ring {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      position: absolute;
      top: 0;
      left: 0;
    }

    .energy-ring-bg, .tasks-ring-bg {
      fill: none;
      stroke: var(--glass-border);
      stroke-width: 8;
    }

    .energy-ring-fill {
      fill: none;
      stroke: url(#energyGradient);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 1s ease;
    }

    .tasks-ring-fill {
      fill: none;
      stroke: var(--success);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 1s ease;
    }

    .energy-value, .tasks-percent {
      font-size: 20px;
      font-weight: 700;
      z-index: 1;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .stat-box {
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s;
    }

    .stat-box:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .stat-box-clickable {
      border: 2px solid var(--accent);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(34, 211, 238, 0.1));
    }

    .stat-box-clickable:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.3);
    }

    .stat-box-clickable:active {
      transform: translateY(0);
    }

    .stat-box-icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
    }

    .stat-box-icon svg {
      color: inherit;
    }

    .stat-box-value {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }

    .stat-box-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Tasks Count Badge */
    .tasks-count {
      background: var(--accent-glow);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Progress Tasks List */
    .progress-tasks-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .progress-task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--bg-input);
      border-radius: 12px;
      transition: all 0.3s;
    }

    .progress-task-item.completed {
      background: rgba(16, 185, 129, 0.1);
    }

    .progress-task-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .progress-task-item.completed .progress-task-checkbox {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
      animation: checkmark 0.3s ease;
    }

    @keyframes checkmark {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .progress-task-text {
      flex: 1;
      font-size: 14px;
    }

    .progress-task-item.completed .progress-task-text {
      text-decoration: line-through;
      opacity: 0.7;
    }

    .progress-task-item.completed .task-meta {
      opacity: 0.5;
    }

    /* Progress Goals List */
    .progress-goals-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .progress-goal-item {
      background: var(--bg-input);
      border-radius: 16px;
      padding: 16px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .progress-goal-item:hover {
      transform: translateX(4px);
      border-left: 3px solid var(--accent);
    }

    .progress-goal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .progress-goal-title {
      font-size: 15px;
      font-weight: 500;
    }

    .progress-goal-percent {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .progress-goal-bar {
      height: 8px;
      background: var(--glass-border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-goal-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 1s ease;
      position: relative;
      overflow: hidden;
    }

    /* Goals Overview Screen */
    .goals-overview-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .goal-overview-card {
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .goal-overview-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .goal-overview-card:active {
      transform: translateY(0);
    }

    .goal-overview-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .goal-overview-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .goal-overview-status {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      font-weight: 500;
    }

    .goal-overview-status.open {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .goal-overview-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .goal-overview-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .goal-overview-meta-item svg {
      width: 14px;
      height: 14px;
    }

    .goal-overview-progress {
      height: 6px;
      background: var(--glass-border);
      border-radius: 3px;
      overflow: hidden;
    }

    .goal-overview-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .goal-overview-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .goal-overview-empty-icon {
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .goal-overview-empty-icon svg {
      width: 48px;
      height: 48px;
    }

    /* Achieved Goals Screen */
    .achieved-goals-header {
      text-align: center;
    }

    .achieved-trophy-icon {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
      color: #fbbf24;
    }

    .achieved-goal-card {
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .achieved-goal-card:hover {
      transform: translateY(-2px);
      border-color: var(--success);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
    }

    .achieved-goal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .achieved-goal-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .achieved-goal-badge {
      background: linear-gradient(135deg, #10b981, #34d399);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .achieved-goal-badge svg {
      width: 12px;
      height: 12px;
    }

    .achieved-goal-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .achieved-stat {
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
    }

    .achieved-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .achieved-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .achieved-goal-plan {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      padding: 12px;
    }

    .achieved-plan-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .achieved-plan-tasks {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .achieved-plan-task {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text);
    }

    .achieved-plan-task svg {
      width: 14px;
      height: 14px;
      color: var(--success);
    }

    .achieved-empty {
      text-align: center;
      padding: 60px 20px;
    }

    .achieved-empty-icon {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .achieved-empty-icon svg {
      width: 64px;
      height: 64px;
      color: var(--text-muted);
    }

    .achieved-empty-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .achieved-empty-text {
      font-size: 14px;
      color: var(--text-muted);
    }

    .progress-goal-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-goal-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Gradient definitions for SVG */
    .svg-gradients {
      position: absolute;
      width: 0;
      height: 0;
    }

    /* Empty state for progress */
    .progress-empty {
      text-align: center;
      padding: 30px 0;
      color: var(--text-muted);
    }

    .progress-empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .progress-empty-icon svg {
      color: inherit;
    }

    .progress-empty .btn {
      width: 100%;
      background: var(--gradient-primary) !important;
      border-radius: 30px;
      padding: 16px 28px;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    /* Mood colors */
    .mood-great { color: #10b981; }
    .mood-good { color: #6366f1; }
    .mood-neutral { color: #f59e0b; }
    .mood-bad { color: #ef4444; }
    .mood-terrible { color: #dc2626; }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      opacity: 0;
      transform: translateY(20px);
      animation: toastIn 0.3s ease forwards;
      pointer-events: auto;
    }

    .toast.toast-out {
      animation: toastOut 0.3s ease forwards;
    }

    .toast-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .toast-success { border-left: 4px solid var(--success); }
    .toast-success .toast-icon { color: var(--success); }

    .toast-error { border-left: 4px solid var(--danger); }
    .toast-error .toast-icon { color: var(--danger); }

    .toast-info { border-left: 4px solid var(--accent); }
    .toast-info .toast-icon { color: var(--accent); }

    .toast-warning { border-left: 4px solid var(--warning); }
    .toast-warning .toast-icon { color: var(--warning); }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    .toast-action {
      background: transparent;
      border: 1px solid currentColor;
      color: var(--accent);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      pointer-events: auto;
      margin-left: 8px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .toast-action:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Confetti Canvas */
    .confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- SVG Gradients for animated circles -->
  <svg class="svg-gradients">
    <defs>
      <linearGradient id="energyGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#6366f1"/>
        <stop offset="100%" style="stop-color:#06b6d4"/>
      </linearGradient>
      <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#10b981"/>
        <stop offset="100%" style="stop-color:#06b6d4"/>
      </linearGradient>
    </defs>
  </svg>

  <div class="bg-animation"></div>

  <!-- Toast Notifications Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Achievement Popup -->
  <div class="achievement-overlay" id="achievementOverlay" onclick="hideAchievementPopup()"></div>
  <div class="achievement-popup" id="achievementPopup">
    <button class="achievement-popup-close" onclick="hideAchievementPopup()">&times;</button>
    <div class="achievement-popup-icon" id="achievementPopupIcon">🏆</div>
    <div class="achievement-popup-title" id="achievementPopupTitle">Achievement freigeschaltet!</div>
    <div class="achievement-popup-desc" id="achievementPopupDesc">Du hast etwas Tolles erreicht!</div>
    <div class="achievement-popup-xp" id="achievementPopupXp">+100 XP</div>
  </div>

  <!-- Confetti Canvas -->
  <canvas class="confetti-canvas" id="confettiCanvas"></canvas>

  <div class="container">
    <!-- Global Header -->
    <div class="app-header" id="globalHeader" style="display: none;">
      <div class="app-header-content">
        <div class="header-bar">
          <div class="header-left">
            <h1 class="app-header-title">aiday</h1>
          </div>
          <div class="header-center">
            <button class="progress-btn" id="headerNavBtn" onclick="onHeaderNavClick()">
              <svg id="headerNavIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="20" x2="12" y2="10"/>
                <line x1="18" y1="20" x2="18" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="16"/>
              </svg>
              <span id="headerNavText">Mein Fortschritt</span>
            </button>
          </div>
          <div class="header-right">
            <span class="header-email" id="headerUserEmail"></span>
            <span class="header-logout" onclick="logout()">Abmelden</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Overview Screen -->
    <div class="screen" id="progressScreen">
      <!-- Today's Status Card -->
      <div class="card progress-card animate-in">
        <div class="progress-card-header">
          <h3>Heute</h3>
          <span class="progress-date" id="progressDate"></span>
        </div>

        <!-- Speech Bubble über den Stats -->
        <div class="dashboard-bubble-container">
          <div class="mood-speech-bubble dashboard-bubble" id="moodSpeechBubble"></div>
        </div>

        <div class="today-stats">
          <div class="stat-circle-container">
            <div class="stat-circle" id="moodCircle">
              <span class="stat-emoji" id="moodEmoji">😊</span>
              <!-- Animated Mood Face -->
              <div class="mood-face good" id="moodFace" onclick="onMoodFaceClick()">
                <svg class="mood-face-svg" viewBox="0 0 64 64">
                  <!-- Face Background -->
                  <circle class="face-bg" cx="32" cy="32" r="30"/>

                  <!-- Sparkles (for great mood) -->
                  <circle class="face-sparkle sparkle-1" cx="8" cy="12" r="3"/>
                  <circle class="face-sparkle sparkle-2" cx="56" cy="16" r="2.5"/>
                  <circle class="face-sparkle sparkle-3" cx="52" cy="52" r="2"/>

                  <!-- Stars (for neutral click animation) -->
                  <polygon class="face-star" points="8,8 10,14 16,14 11,18 13,24 8,20 3,24 5,18 0,14 6,14" transform="translate(0, 0)"/>
                  <polygon class="face-star" points="8,8 10,14 16,14 11,18 13,24 8,20 3,24 5,18 0,14 6,14" transform="translate(48, 2) scale(0.8)"/>

                  <!-- Hug Arms (for terrible click animation) -->
                  <path class="face-hug-arm" d="M-5 32 Q-10 20, 0 15" fill="none"/>
                  <path class="face-hug-arm" d="M69 32 Q74 20, 64 15" fill="none"/>

                  <!-- Hearts (for bad/terrible click animation) -->
                  <path class="face-heart heart-1" d="M32 8 C32 4, 28 0, 24 4 C20 8, 24 12, 32 18 C40 12, 44 8, 40 4 C36 0, 32 4, 32 8" transform="translate(-8, -5) scale(0.6)"/>
                  <path class="face-heart heart-2" d="M32 8 C32 4, 28 0, 24 4 C20 8, 24 12, 32 18 C40 12, 44 8, 40 4 C36 0, 32 4, 32 8" transform="translate(20, -3) scale(0.5)"/>
                  <path class="face-heart heart-3" d="M32 8 C32 4, 28 0, 24 4 C20 8, 24 12, 32 18 C40 12, 44 8, 40 4 C36 0, 32 4, 32 8" transform="translate(6, -8) scale(0.4)"/>

                  <!-- Eyebrows (for sad moods) -->
                  <path class="face-brow brow-left" d="M18 22 Q22 18, 26 22"/>
                  <path class="face-brow brow-right" d="M38 22 Q42 18, 46 22"/>

                  <!-- Eyes -->
                  <ellipse class="face-eye eye-left" cx="22" cy="28" rx="4" ry="5"/>
                  <ellipse class="face-eye eye-right" cx="42" cy="28" rx="4" ry="5"/>

                  <!-- Cheeks -->
                  <circle class="face-cheek" cx="14" cy="38" r="6"/>
                  <circle class="face-cheek" cx="50" cy="38" r="6"/>

                  <!-- Mouth - will be updated by JS -->
                  <path class="face-mouth" id="faceMouth" d="M20 42 Q32 52, 44 42"/>

                  <!-- Tongue (for good click animation) -->
                  <ellipse class="face-tongue" cx="32" cy="52" rx="6" ry="8"/>

                  <!-- Tear (for terrible mood) -->
                  <ellipse class="face-tear" cx="22" cy="36" rx="2" ry="3"/>
                </svg>
              </div>
            </div>
            <div class="stat-label">Stimmung</div>
            <div class="stat-value" id="moodValue">Gut</div>
          </div>

          <div class="stat-circle-container">
            <div class="stat-circle energy-circle" id="energyCircle">
              <svg class="energy-ring" viewBox="0 0 100 100">
                <circle class="energy-ring-bg" cx="50" cy="50" r="45"/>
                <circle class="energy-ring-fill" cx="50" cy="50" r="45" id="energyRing"/>
              </svg>
              <span class="energy-value" id="energyValue">4</span>
            </div>
            <div class="stat-label">Energie</div>
            <div class="stat-value" id="energyText">Hoch</div>
          </div>

          <div class="stat-circle-container">
            <div class="stat-circle tasks-circle">
              <svg class="tasks-ring" viewBox="0 0 100 100">
                <circle class="tasks-ring-bg" cx="50" cy="50" r="45"/>
                <circle class="tasks-ring-fill" cx="50" cy="50" r="45" id="tasksRing"/>
              </svg>
              <span class="tasks-percent" id="tasksPercent">0%</span>
            </div>
            <div class="stat-label">Aufgaben</div>
            <div class="stat-value" id="tasksValue">0/0</div>
          </div>
        </div>

        <!-- Motivation Speech Bubble -->
        <div class="motivation-speech-bubble" id="motivationBubble">
          <div class="quote-text"></div>
          <div class="quote-author"></div>
        </div>
      </div>

      <!-- Gamification Card -->
      <div class="gamification-card animate-in" style="animation-delay: 0.05s;" id="gamificationCard">
        <div class="gamification-header">
          <div class="level-badge" id="levelBadge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            <span>Level <span id="userLevel">1</span></span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span class="xp-text"><span id="currentXp">0</span> / <span id="nextLevelXp">100</span> XP</span>
            <button class="gamification-info-btn" onclick="showAchievementsInfo()" title="Wie funktioniert das?">?</button>
          </div>
        </div>
        <div class="xp-bar-container">
          <div class="xp-bar-progress" id="xpBarProgress" style="width: 0%"></div>
        </div>
        <div class="achievements-preview" id="achievementsPreview">
          <!-- Wird dynamisch gefüllt -->
        </div>
      </div>

      <!-- Streak & Stats Card -->
      <div class="card progress-card animate-in" style="animation-delay: 0.1s;">
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-box-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
              </svg>
            </div>
            <div class="stat-box-value" id="streakValue">0</div>
            <div class="stat-box-label">Tage Streak</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
            </div>
            <div class="stat-box-value" id="tasksCompletedValue">0</div>
            <div class="stat-box-label">Aufgaben erledigt</div>
          </div>
          <div class="stat-box stat-box-clickable" onclick="showGoalsOverview()" style="cursor: pointer;">
            <div class="stat-box-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
              </svg>
            </div>
            <div class="stat-box-value" id="goalsActiveValue">0</div>
            <div class="stat-box-label">Aktive Ziele</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="20" x2="12" y2="10"/>
                <line x1="18" y1="20" x2="18" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="16"/>
              </svg>
            </div>
            <div class="stat-box-value" id="avgProgressValue">0%</div>
            <div class="stat-box-label">Ø Fortschritt</div>
          </div>
        </div>
      </div>

      <!-- Today's Tasks Card -->
      <div class="card progress-card animate-in" style="animation-delay: 0.2s;">
        <div class="progress-card-header">
          <h3>Heutige Aufgaben</h3>
          <span class="tasks-count" id="todayTasksCount">0 Aufgaben</span>
        </div>
        <div id="progressTodayTasks" class="progress-tasks-list"></div>
      </div>

      <!-- Footer Back Button -->
      <div class="card" style="margin-top: 20px;">
        <button class="footer-back-btn" onclick="closeProgressScreen()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Task Detail Screen -->
    <div class="screen" id="taskDetailScreen">
      <div class="card">
        <div class="task-detail-header">
          <span class="task-detail-time" id="taskDetailTime">⏰ Flexibel</span>
          <span class="task-detail-duration" id="taskDetailDuration">~15 Min</span>
        </div>

        <h2 class="task-detail-title" id="taskDetailTitle">Aufgabentitel</h2>

        <div class="task-detail-why" id="taskDetailWhy">
          <strong>Warum diese Aufgabe?</strong>
          <p>Erklärung...</p>
        </div>

        <div class="task-detail-steps" id="taskDetailSteps">
          <strong>So gehst du vor:</strong>
          <ol>
            <li>Schritt 1</li>
            <li>Schritt 2</li>
            <li>Schritt 3</li>
          </ol>
        </div>

        <div class="task-detail-actions">
          <button class="btn btn-secondary" id="taskStartBtn" onclick="startTask()">
            ▶️ Starten
          </button>
          <button class="btn btn-primary" id="taskCompleteBtn" onclick="completeTaskFromDetail()">
            ✓ Erledigt
          </button>
        </div>

        <button class="footer-back-btn" onclick="goBackFromTaskDetail()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Loading Screen - startet als aktiv -->
    <div class="screen active" id="loadingScreen">
      <div class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Lade deine Daten...</div>
      </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="onboarding-overlay" id="onboardingOverlay">
      <div class="onboarding-modal">
        <button class="onboarding-skip" onclick="skipOnboarding()">Überspringen</button>

        <div class="onboarding-slides" id="onboardingSlides">
          <!-- Slide 1: Dein täglicher Flow -->
          <div class="onboarding-slide active" data-slide="0">
            <div class="onboarding-icon">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
              </svg>
            </div>
            <h2 class="onboarding-title">Dein täglicher Flow</h2>
            <p class="onboarding-text">
              <strong>1. Check-in</strong> - Starte mit deiner Stimmung & Energie<br>
              <strong>2. Ziel setzen</strong> - Was möchtest du heute erreichen?<br>
              <strong>3. Plan folgen</strong> - Die AI erstellt deinen Aktionsplan
            </p>
          </div>

          <!-- Slide 2: Gamification -->
          <div class="onboarding-slide" data-slide="1">
            <div class="onboarding-icon">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="1.5">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
              </svg>
            </div>
            <h2 class="onboarding-title">Level up mit Gamification</h2>
            <p class="onboarding-text">
              <strong>+10 XP</strong> für jede erledigte Aufgabe<br>
              <strong>+50 XP</strong> Bonus wenn alle Tasks erledigt<br>
              <strong>Achievements</strong> für Streaks & Meilensteine<br>
              Steige Level auf und sammle Badges!
            </p>
          </div>

          <!-- Slide 3: Profil -->
          <div class="onboarding-slide" data-slide="2">
            <div class="onboarding-icon">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--accent-2)" stroke-width="1.5">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <h2 class="onboarding-title">Personalisiere deine AI</h2>
            <p class="onboarding-text">
              Fülle dein Profil aus für <strong>bessere Empfehlungen</strong>.<br><br>
              Je mehr die AI über dich weiß (Beruf, Hobbys, Ziele),<br>
              desto relevanter werden deine täglichen Aufgaben!
            </p>
          </div>
        </div>

        <div class="onboarding-dots" id="onboardingDots">
          <span class="onboarding-dot active" data-dot="0"></span>
          <span class="onboarding-dot" data-dot="1"></span>
          <span class="onboarding-dot" data-dot="2"></span>
        </div>

        <div class="onboarding-actions">
          <button class="btn btn-secondary onboarding-prev" id="onboardingPrev" onclick="prevOnboardingSlide()" style="visibility: hidden;">Zurück</button>
          <button class="btn btn-primary onboarding-next" id="onboardingNext" onclick="nextOnboardingSlide()">Weiter</button>
        </div>
      </div>
    </div>

    <!-- Achievements Info Modal -->
    <div class="achievements-info-overlay" id="achievementsInfoOverlay">
      <div class="achievements-info-modal">
        <button class="achievements-info-close" onclick="hideAchievementsInfo()">&times;</button>

        <div class="achievements-info-header">
          <div class="achievements-info-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="1.5">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          </div>
          <h2 class="achievements-info-title">Level & Achievements</h2>
          <p class="achievements-info-subtitle">So funktioniert das Gamification-System</p>
        </div>

        <div class="xp-info-section">
          <h3 class="xp-info-title">XP verdienen</h3>
          <div class="xp-info-table">
            <div class="xp-info-row">
              <span class="xp-info-action">Aufgabe erledigt</span>
              <span class="xp-info-value">+10 XP</span>
            </div>
            <div class="xp-info-row">
              <span class="xp-info-action">Alle Tagesaufgaben erledigt</span>
              <span class="xp-info-value">+50 XP</span>
            </div>
            <div class="xp-info-row">
              <span class="xp-info-action">Streak fortgesetzt</span>
              <span class="xp-info-value">+20 XP</span>
            </div>
            <div class="xp-info-row highlight">
              <span class="xp-info-action">Ziel erreicht</span>
              <span class="xp-info-value">+100 XP</span>
            </div>
          </div>
        </div>

        <div class="achievements-info-section">
          <h3 class="xp-info-title">Achievements</h3>
          <div class="achievements-info-grid" id="achievementsInfoGrid">
            <div class="achievement-info-item">
              <span class="achievement-info-icon">🎯</span>
              <span class="achievement-info-name">Erster Schritt</span>
              <span class="achievement-info-desc">Erstelle dein erstes Ziel</span>
            </div>
            <div class="achievement-info-item">
              <span class="achievement-info-icon">✅</span>
              <span class="achievement-info-name">Macher</span>
              <span class="achievement-info-desc">Erledige deine erste Aufgabe</span>
            </div>
            <div class="achievement-info-item">
              <span class="achievement-info-icon">🔥</span>
              <span class="achievement-info-name">3-Tage-Streak</span>
              <span class="achievement-info-desc">3 Tage in Folge aktiv</span>
            </div>
            <div class="achievement-info-item">
              <span class="achievement-info-icon">💪</span>
              <span class="achievement-info-name">Wochenkämpfer</span>
              <span class="achievement-info-desc">7 Tage Streak</span>
            </div>
            <div class="achievement-info-item">
              <span class="achievement-info-icon">⭐</span>
              <span class="achievement-info-name">Fleißig</span>
              <span class="achievement-info-desc">10 Aufgaben erledigt</span>
            </div>
            <div class="achievement-info-item">
              <span class="achievement-info-icon">🌈</span>
              <span class="achievement-info-name">Perfekter Tag</span>
              <span class="achievement-info-desc">Alle Tagesaufgaben erledigt</span>
            </div>
          </div>
        </div>

        <div class="level-info-section">
          <h3 class="xp-info-title">Level-System</h3>
          <p class="level-info-text">
            Dein Level steigt basierend auf deiner gesammelten XP.<br>
            <strong>Formel:</strong> Level = √(XP / 100) + 1
          </p>
          <div class="level-info-examples">
            <span>Level 2: 100 XP</span>
            <span>Level 3: 400 XP</span>
            <span>Level 5: 1.600 XP</span>
            <span>Level 10: 8.100 XP</span>
          </div>
        </div>

        <button class="btn btn-primary achievements-info-btn" onclick="hideAchievementsInfo()">
          Verstanden!
        </button>
      </div>
    </div>

    <!-- Weekly Report Modal -->
    <div class="weekly-report-overlay" id="weeklyReportOverlay">
      <div class="weekly-report-modal">
        <button class="weekly-report-close" onclick="hideWeeklyReport()">&times;</button>

        <div class="weekly-report-header">
          <div class="weekly-report-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <h2 class="weekly-report-title">Deine Woche</h2>
          <p class="weekly-report-subtitle" id="weeklyReportDateRange">Diese Woche</p>
        </div>

        <div class="weekly-report-stats">
          <div class="weekly-stat">
            <div class="weekly-stat-value" id="weeklyTasksCompleted">0/0</div>
            <div class="weekly-stat-label">Aufgaben erledigt</div>
            <div class="weekly-stat-bar">
              <div class="weekly-stat-bar-fill" id="weeklyTasksBar" style="width: 0%"></div>
            </div>
          </div>

          <div class="weekly-stat">
            <div class="weekly-stat-value" id="weeklyStreak">0 Tage</div>
            <div class="weekly-stat-label">Aktuelle Streak</div>
          </div>

          <div class="weekly-stat">
            <div class="weekly-stat-value" id="weeklyXP">+0 XP</div>
            <div class="weekly-stat-label">Diese Woche verdient</div>
          </div>

          <div class="weekly-stat">
            <div class="weekly-stat-value" id="weeklyMood">-</div>
            <div class="weekly-stat-label">Durchschnittliche Stimmung</div>
          </div>
        </div>

        <div class="weekly-report-message" id="weeklyReportMessage">
          Weiter so! Du bist auf dem richtigen Weg.
        </div>

        <button class="btn btn-primary weekly-report-btn" onclick="hideWeeklyReport()">
          Weiter machen!
        </button>
      </div>
    </div>

    <!-- Profile Screen -->
    <div class="screen" id="profileScreen">
      <div class="card">
        <div class="profile-header">
          <div class="profile-header-text">
            <h2 class="card-title">Mein Profil</h2>
            <p class="card-subtitle">Persönliche Daten helfen der AI, bessere Empfehlungen zu geben</p>
          </div>
          <div class="profile-completion-ring" id="profileCompletionRing" title="Profil-Vollständigkeit">
            <svg viewBox="0 0 36 36">
              <path class="profile-ring-bg"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke-width="3"
              />
              <path class="profile-ring-fill" id="profileRingFill"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke-width="3"
                stroke-dasharray="0, 100"
              />
            </svg>
            <span class="profile-ring-text" id="profileRingText">0%</span>
          </div>
        </div>
        <p class="profile-completion-hint" id="profileCompletionHint">Vervollständige dein Profil für bessere Empfehlungen</p>

        <div class="form-group">
          <label class="form-label">Alter</label>
          <input type="number" class="form-input" id="profileAge" placeholder="z.B. 28" min="10" max="120">
        </div>

        <div class="form-group">
          <label class="form-label">Beruf</label>
          <input type="text" class="form-input" id="profileJob" placeholder="z.B. Software-Entwickler">
        </div>

        <div class="form-group">
          <label class="form-label">Bildung</label>
          <select class="form-input" id="profileEducation">
            <option value="">Bitte wählen...</option>
            <option value="hauptschule">Hauptschulabschluss</option>
            <option value="realschule">Realschulabschluss</option>
            <option value="abitur">Abitur</option>
            <option value="ausbildung">Berufsausbildung</option>
            <option value="bachelor">Bachelor</option>
            <option value="master">Master</option>
            <option value="promotion">Promotion</option>
            <option value="other">Sonstiges</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Familienstand</label>
          <select class="form-input" id="profileFamily">
            <option value="">Bitte wählen...</option>
            <option value="single">Single</option>
            <option value="relationship">In einer Beziehung</option>
            <option value="married">Verheiratet</option>
            <option value="divorced">Geschieden</option>
            <option value="widowed">Verwitwet</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Hobbys & Interessen</label>
          <textarea class="form-textarea" id="profileHobbies" placeholder="z.B. Sport, Lesen, Musik, Reisen..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Persönliche Stärken</label>
          <textarea class="form-textarea" id="profileStrengths" placeholder="z.B. Kreativität, Durchhaltevermögen, Teamarbeit..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Größte Herausforderungen</label>
          <textarea class="form-textarea" id="profileChallenges" placeholder="z.B. Zeitmanagement, Prokrastination, Work-Life-Balance..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Lebensmotto / Was dich antreibt</label>
          <textarea class="form-textarea" id="profileMotivation" placeholder="z.B. Familie, Freiheit, Erfolg, Wissen..."></textarea>
        </div>

        <!-- Appearance Section -->
        <div class="profile-section-divider"></div>
        <h3 class="profile-section-title">Darstellung</h3>

        <div class="form-group theme-toggle-group">
          <label class="form-label">Dark Mode</label>
          <div class="theme-toggle-container">
            <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleDarkMode()">
              <span class="theme-toggle-icon light-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="5"/>
                  <line x1="12" y1="1" x2="12" y2="3"/>
                  <line x1="12" y1="21" x2="12" y2="23"/>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                  <line x1="1" y1="12" x2="3" y2="12"/>
                  <line x1="21" y1="12" x2="23" y2="12"/>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
              </span>
              <span class="theme-toggle-icon dark-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
              </span>
              <span class="theme-toggle-slider"></span>
            </button>
            <span class="theme-toggle-label" id="themeToggleLabel">Hell</span>
          </div>
        </div>

        <button class="btn btn-primary" id="profileSaveBtn" onclick="saveProfile()">Profil speichern</button>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="closeProfileScreen()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Daily Check-in Screen -->
    <div class="screen" id="checkinScreen">
      <div class="card">
        <h2 class="card-title">Guten Tag!</h2>

        <div class="form-group mood-form-group" id="moodFormGroup">
          <!-- Speech Bubble -->
          <div class="mood-speech-bubble" id="moodSpeechBubbleCheckin">Wie fühlst du dich heute? 🤔</div>
          <p class="card-subtitle" style="margin-bottom: 12px;">Wie geht es dir heute?</p>
          <div class="mood-selector mood-buttons" id="moodButtons">
            <button class="mood-btn" data-mood="great" onclick="selectMood('great')">😊</button>
            <button class="mood-btn" data-mood="good" onclick="selectMood('good')">🙂</button>
            <button class="mood-btn" data-mood="neutral" onclick="selectMood('neutral')">😐</button>
            <button class="mood-btn" data-mood="bad" onclick="selectMood('bad')">😔</button>
            <button class="mood-btn" data-mood="terrible" onclick="selectMood('terrible')">😢</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Was beschäftigt dich gerade?</label>
          <textarea class="form-textarea" id="moodNote" placeholder="Optional: Erzähl mir mehr..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Was hast du dir für heute vorgenommen?</label>
          <textarea class="form-textarea" id="plannedToday" placeholder="Was steht heute an?"></textarea>
        </div>

        <div class="form-group energy-form-group" id="energyFormGroup">
          <!-- Speech Bubble -->
          <div class="energy-speech-bubble" id="energySpeechBubble">Bitte wähle dein Energielevel! ⚡</div>
          <p class="card-subtitle" style="margin-bottom: 12px;">Wie ist dein Energielevel?</p>
          <div class="energy-slider" id="energySlider">
            <button class="energy-level" data-level="1" onclick="selectEnergy(1)">1</button>
            <button class="energy-level" data-level="2" onclick="selectEnergy(2)">2</button>
            <button class="energy-level" data-level="3" onclick="selectEnergy(3)">3</button>
            <button class="energy-level" data-level="4" onclick="selectEnergy(4)">4</button>
            <button class="energy-level" data-level="5" onclick="selectEnergy(5)">5</button>
          </div>
        </div>

        <button class="btn btn-primary" id="checkinSubmit" onclick="submitCheckin()">Weiter</button>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="goBackFromCheckin()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Goals Setup Screen -->
    <div class="screen" id="goalsScreen">
      <div class="card">
        <div class="goal-number" id="goalNumber">Ziel 1</div>
        <h2 class="card-title">Definiere dein Ziel</h2>
        <p class="card-subtitle" id="goalSubtitle">Was möchtest du erreichen?</p>

        <div class="form-group">
          <label class="form-label">Dein Ziel *</label>
          <input type="text" class="form-input" id="goalTitle" placeholder="z.B. 100.000€ Umsatz, 10kg abnehmen...">
        </div>

        <div class="form-group">
          <label class="form-label">Warum ist dir das wichtig?</label>
          <textarea class="form-textarea" id="goalWhy" placeholder="Was motiviert dich?"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Was hast du bisher dafür getan?</label>
          <textarea class="form-textarea" id="goalPrevious" placeholder="Bisherige Versuche oder Schritte..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Was glaubst du, musst du dafür tun?</label>
          <textarea class="form-textarea" id="goalSteps" placeholder="Deine Ideen..."></textarea>
        </div>

        <button class="btn btn-primary" id="goalSubmit" onclick="checkGoalAndProceed()">Weiter</button>

        <button class="btn btn-secondary" id="goalAdd" onclick="addAnotherGoal()" style="margin-top: 12px; display: none;">
          + Weiteres Ziel hinzufügen
        </button>

        <div id="savedGoalsList" style="margin-top: 24px;"></div>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="goBackFromGoals()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Goal Clarification Screen -->
    <div class="screen" id="clarifyScreen">
      <div class="card">
        <div class="ai-badge">🤖 AI-Analyse</div>
        <h2 class="card-title" id="clarifyGoalTitle">Dein Ziel konkretisieren</h2>
        <p class="card-subtitle" id="clarifyReason">Um dir einen wirklich hilfreichen Plan zu erstellen, brauche ich noch ein paar Details.</p>

        <div id="clarifyQuestions"></div>

        <button class="btn btn-primary" id="clarifySubmit" onclick="submitClarification()">Plan erstellen lassen</button>
        <button class="btn btn-secondary" onclick="skipClarification()" style="margin-top: 12px;">Ohne Details fortfahren</button>

        <p style="font-size: 12px; color: var(--text-muted); text-align: center; margin-top: 16px;">
          Je mehr Details du angibst, desto besser kann die AI deinen Plan personalisieren.
        </p>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="goBackFromClarify()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Goals Overview Screen -->
    <div class="screen" id="goalsOverviewScreen">
      <div class="card">
        <h2 class="card-title">Deine Ziele</h2>
        <p class="card-subtitle">Übersicht aller aktiven Ziele</p>
      </div>

      <div id="goalsOverviewList" class="goals-overview-list"></div>

      <div class="card" style="margin-top: 20px;">
        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="closeGoalsOverview()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Goal Detail Screen -->
    <div class="screen" id="goalDetailScreen">
      <div class="card" id="goalDetailCard">
        <div class="goal-detail-header">
          <h2 class="card-title" id="goalDetailTitle">Ziel</h2>
          <div class="goal-progress-badge" id="goalDetailStatus">Aktiv</div>
        </div>

        <div id="goalDetailProgress"></div>

        <div id="goalDetailInfo" style="margin-top: 20px;"></div>

        <div id="goalDetailMilestones" style="margin-top: 20px;"></div>

        <div id="goalDetailTasks" style="margin-top: 20px;"></div>

        <!-- Delete Goal Button -->
        <button class="btn-delete-goal" onclick="confirmDeleteGoal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
          Ziel löschen
        </button>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="closeGoalDetail()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück
        </button>
      </div>
    </div>

    <!-- Achieved Goals Screen -->
    <div class="screen" id="achievedGoalsScreen">
      <div class="card">
        <div class="achieved-goals-header">
          <div class="achieved-trophy-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
              <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
              <path d="M4 22h16"/>
              <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
              <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
              <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
          </div>
          <h2 class="card-title">Erreichte Ziele</h2>
          <p class="card-subtitle">Deine erfolgreich abgeschlossenen Ziele</p>
        </div>
      </div>

      <div id="achievedGoalsList"></div>

      <div class="card" style="margin-top: 20px;">
        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="showScreen('dashboardScreen')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück zum Dashboard
        </button>
      </div>
    </div>

    <!-- AI Plan Screen -->
    <div class="screen" id="planScreen">
      <div class="card">
        <h2 class="card-title">Dein persönlicher Plan</h2>
        <p class="card-subtitle">Prüfe den Vorschlag und nimm ihn an, um zu starten</p>
      </div>

      <div id="planCards"></div>

      <div class="card" style="margin-top: 20px;">
        <button class="btn btn-primary" id="acceptPlanBtn" onclick="acceptPlan()">Plan annehmen</button>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="rejectPlan()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Zurück zum Hauptmenü
        </button>
      </div>
    </div>

    <!-- Daily Review Screen -->
    <div class="screen" id="reviewScreen">
      <div class="card">
        <h2 class="card-title">Wie lief es gestern?</h2>
        <p class="card-subtitle">Lass uns deinen Fortschritt besprechen</p>
      </div>

      <div id="reviewTasks"></div>

      <div class="card" style="margin-top: 20px;">
        <button class="btn btn-primary" id="reviewSubmit" onclick="submitReview()">Weiter</button>

        <!-- Footer Back Button -->
        <button class="footer-back-btn" onclick="skipReview()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Überspringen
        </button>
      </div>
    </div>

    <!-- Dashboard Screen -->
    <div class="screen" id="dashboardScreen">
      <!-- Body Section -->
      <div class="app-body">
        <!-- Quick Actions -->
        <div class="quick-actions">
          <h2 class="quick-actions-title">Übersicht</h2>
          <div class="quick-actions-grid">
            <button class="quick-action-btn" onclick="showCheckinScreen()">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </div>
              <span class="quick-action-label">Check-in</span>
            </button>
            <button class="quick-action-btn" onclick="startNewGoal()">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="6"/>
                  <circle cx="12" cy="12" r="2"/>
                </svg>
              </div>
              <span class="quick-action-label">Neues Ziel</span>
            </button>
            <button class="quick-action-btn" onclick="showAchievedGoalsScreen()">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                  <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                  <path d="M4 22h16"/>
                  <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                  <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                  <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                </svg>
              </div>
              <span class="quick-action-label">Erreichte Ziele</span>
            </button>
            <button class="quick-action-btn" onclick="showProfileScreen()">
              <div class="quick-action-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </div>
              <span class="quick-action-label">Mein Profil</span>
            </button>
          </div>
        </div>

        <!-- Today's Tasks Card -->
        <div class="card dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title">Heutige Aufgaben</h2>
            <span class="tasks-badge" id="tasksBadge">0</span>
          </div>
          <div class="task-list" id="todayTasks"></div>
        </div>

        <!-- Goals Progress Card -->
        <div class="card dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title">Deine Ziele</h2>
            <button class="see-all-btn" onclick="showProgressScreen()">Alle →</button>
          </div>
          <div id="goalsProgressList"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://boghlkwclgywpiienmtm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvZ2hsa3djbGd5d3BpaWVubXRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NTIyMjUsImV4cCI6MjA4NDIyODIyNX0.IUDYw2IJXc6jKCCjSUIG5yzWkyiW5Id5xgTmhFG36rU';

    // State
    let accessToken = '';
    let currentGoalIndex = 0;
    let goals = [];
    let checkinData = { mood: null, energy_level: null };
    let reviewData = [];
    let appData = null;
    let previousScreen = 'dashboardScreen';
    let currentGoalDetail = null;
    let currentTaskDetail = null;
    let taskDetailPreviousScreen = 'dashboardScreen';

    // Motivation System Variables (must be declared before init)
    let lastMotivationTime = 0;
    const MOTIVATION_COOLDOWN = 4 * 60 * 60 * 1000; // 4 Stunden in Millisekunden
    let pendingMotivationMood = null; // Mood from check-in, shown on progress screen

    // Gamification State
    let gamificationData = {
      total_xp: 0,
      level: 1,
      achievements: [],
      earnedAchievements: []
    };

    // Timezone-Offset für API-Calls (muss vor init definiert sein)
    const userTimezoneOffset = new Date().getTimezoneOffset();

    // ============================================
    // Dark Mode System
    // ============================================
    function initTheme() {
      const savedTheme = localStorage.getItem('aiday_theme');

      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.body.classList.remove('light-mode');
      } else if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        document.body.classList.remove('dark-mode');
      }
      // Wenn kein savedTheme, wird die System-Präferenz per CSS respektiert

      updateThemeToggleUI();
    }

    function toggleDarkMode() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      const prefersSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (isDarkMode) {
        // War dunkel -> jetzt hell
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        localStorage.setItem('aiday_theme', 'light');
      } else {
        // War hell -> jetzt dunkel
        document.body.classList.add('dark-mode');
        document.body.classList.remove('light-mode');
        localStorage.setItem('aiday_theme', 'dark');
      }

      updateThemeToggleUI();
      showToast(document.body.classList.contains('dark-mode') ? 'Dark Mode aktiviert' : 'Light Mode aktiviert', 'info', 1500);
    }

    function updateThemeToggleUI() {
      const isDarkMode = document.body.classList.contains('dark-mode') ||
        (!document.body.classList.contains('light-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches);

      const label = document.getElementById('themeToggleLabel');
      if (label) {
        label.textContent = isDarkMode ? 'Dunkel' : 'Hell';
      }

      // Slider-Position wird per CSS gesteuert (body.dark-mode .theme-toggle-slider)
      // Aber wir müssen die Klasse auch bei System-Präferenz anwenden
      if (!localStorage.getItem('aiday_theme') && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark-mode');
      }
    }

    // Theme beim Laden initialisieren (vor allem anderen)
    initTheme();

    // Auth Check
    (function init() {
      const token = localStorage.getItem('aiday_token');
      const user = localStorage.getItem('aiday_user');

      if (!token) {
        window.location.href = 'start-ui.html';
        return;
      }

      accessToken = token;

      if (user) {
        try {
          const userData = JSON.parse(user);
          const email = userData.email || '';
          document.getElementById('userEmail').textContent = email;
          // Auch im neuen Header
          const headerEmailEl = document.getElementById('headerUserEmail');
          if (headerEmailEl) {
            headerEmailEl.textContent = email;
          }
        } catch (e) {}
      }

      showScreen('loadingScreen');
      loadDailyStart();

      // Motivation System initialisieren
      initMotivationSystem();

      // Swipe Navigation initialisieren
      initSwipeNavigation();
    })();

    function logout() {
      localStorage.removeItem('aiday_token');
      localStorage.removeItem('aiday_user');
      window.location.href = 'start-ui.html';
    }

    // ===== ONBOARDING SYSTEM =====

    let currentOnboardingSlide = 0;
    const totalOnboardingSlides = 3;

    function shouldShowOnboarding() {
      // Onboarding wird bei jedem Login angezeigt
      return true;
    }

    function showOnboarding() {
      const overlay = document.getElementById('onboardingOverlay');
      if (overlay) {
        overlay.classList.add('show');
        currentOnboardingSlide = 0;
        updateOnboardingSlide();
      }
    }

    function hideOnboarding() {
      const overlay = document.getElementById('onboardingOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    function skipOnboarding() {
      hideOnboarding();
    }

    function nextOnboardingSlide() {
      if (currentOnboardingSlide < totalOnboardingSlides - 1) {
        currentOnboardingSlide++;
        updateOnboardingSlide();
      } else {
        // Letzte Slide - Onboarding abschließen
        hideOnboarding();
        showToast('Willkommen bei AIDAY! Los geht\'s!', 'success', 3000);
      }
    }

    function prevOnboardingSlide() {
      if (currentOnboardingSlide > 0) {
        currentOnboardingSlide--;
        updateOnboardingSlide();
      }
    }

    function goToOnboardingSlide(index) {
      currentOnboardingSlide = index;
      updateOnboardingSlide();
    }

    function updateOnboardingSlide() {
      // Slides aktualisieren
      const slides = document.querySelectorAll('.onboarding-slide');
      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === currentOnboardingSlide);
      });

      // Dots aktualisieren
      const dots = document.querySelectorAll('.onboarding-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentOnboardingSlide);
      });

      // Button-Text aktualisieren
      const prevBtn = document.getElementById('onboardingPrev');
      const nextBtn = document.getElementById('onboardingNext');

      if (prevBtn) {
        prevBtn.style.visibility = currentOnboardingSlide === 0 ? 'hidden' : 'visible';
      }

      if (nextBtn) {
        nextBtn.textContent = currentOnboardingSlide === totalOnboardingSlides - 1 ? 'Los geht\'s!' : 'Weiter';
      }
    }

    // Dot-Klick-Handler
    document.addEventListener('DOMContentLoaded', () => {
      const dots = document.querySelectorAll('.onboarding-dot');
      dots.forEach((dot, i) => {
        dot.addEventListener('click', () => goToOnboardingSlide(i));
      });
    });

    // ===== ACHIEVEMENTS INFO MODAL =====

    function showAchievementsInfo() {
      const overlay = document.getElementById('achievementsInfoOverlay');
      if (overlay) {
        overlay.classList.add('show');
      }
    }

    function hideAchievementsInfo() {
      const overlay = document.getElementById('achievementsInfoOverlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    // ===== WEEKLY REPORT SYSTEM =====

    function shouldShowWeeklyReport() {
      // Zeige Report am Sonntag oder wenn eine Woche seit dem letzten Report vergangen ist
      const lastShown = localStorage.getItem('aiday_weekly_report_last');
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0 = Sonntag

      if (!lastShown) {
        // Noch nie gezeigt - nur am Sonntag anzeigen
        return dayOfWeek === 0;
      }

      const lastDate = new Date(lastShown);
      const daysSinceLastReport = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

      // Zeige am Sonntag wenn mindestens 6 Tage vergangen sind
      return dayOfWeek === 0 && daysSinceLastReport >= 6;
    }

    function showWeeklyReport() {
      const overlay = document.getElementById('weeklyReportOverlay');
      if (overlay) {
        calculateWeeklyStats();
        overlay.classList.add('show');
      }
    }

    function hideWeeklyReport() {
      const overlay = document.getElementById('weeklyReportOverlay');
      if (overlay) {
        overlay.classList.remove('show');
        localStorage.setItem('aiday_weekly_report_last', new Date().toISOString());
      }
    }

    function calculateWeeklyStats() {
      // Berechne Statistiken aus den verfügbaren Daten
      const data = appData?.data || {};
      const tasks = data.today_tasks || [];
      const streak = data.streak || 0;

      // Tasks diese Woche (vereinfachte Berechnung aus heute)
      const completedTasks = tasks.filter(t => t.completed).length;
      const totalTasks = tasks.length;
      const taskPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

      // Geschätzte Wochenwerte (basierend auf Streak und heutigen Daten)
      const weeklyTasks = totalTasks * Math.min(7, streak + 1);
      const weeklyCompleted = completedTasks * Math.min(7, streak);

      // XP diese Woche (Schätzung)
      const weeklyXP = completedTasks * 10 * Math.min(7, streak + 1);

      // Datum-Range
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const dateRange = `${weekStart.toLocaleDateString('de-DE', { day: 'numeric', month: 'short' })} - ${today.toLocaleDateString('de-DE', { day: 'numeric', month: 'short' })}`;

      // UI aktualisieren
      document.getElementById('weeklyReportDateRange').textContent = dateRange;
      document.getElementById('weeklyTasksCompleted').textContent = `${weeklyCompleted}/${weeklyTasks || '-'}`;
      document.getElementById('weeklyTasksBar').style.width = `${taskPercent}%`;
      document.getElementById('weeklyStreak').textContent = `${streak} Tag${streak !== 1 ? 'e' : ''}`;
      document.getElementById('weeklyXP').textContent = `+${weeklyXP} XP`;

      // Stimmung (aus Check-in wenn vorhanden)
      const moodLabels = { great: 'Super', good: 'Gut', neutral: 'Okay', bad: 'Mäßig', terrible: 'Schwierig' };
      const todayCheckin = data.today_checkin;
      const moodText = todayCheckin?.mood ? moodLabels[todayCheckin.mood] || '-' : '-';
      document.getElementById('weeklyMood').textContent = moodText;

      // Motivierende Nachricht
      let message = '';
      if (taskPercent >= 80) {
        message = 'Fantastische Woche! Du hast fast alles geschafft. Weiter so!';
      } else if (taskPercent >= 60) {
        message = 'Gute Arbeit! Du bist auf einem tollen Weg.';
      } else if (taskPercent >= 40) {
        message = 'Nicht schlecht! Jede erledigte Aufgabe zählt.';
      } else if (streak > 0) {
        message = `Deine ${streak}-Tage-Streak zeigt deinen Willen. Mach weiter!`;
      } else {
        message = 'Jede Woche ist ein Neustart. Du schaffst das!';
      }
      document.getElementById('weeklyReportMessage').textContent = message;
    }

    // Manueller Trigger für den Weekly Report (z.B. über Button)
    function triggerWeeklyReport() {
      showWeeklyReport();
    }

    // ===== TOAST NOTIFICATIONS =====

    function showToast(message, type = 'info', duration = 3000, actionBtn = null) {
      const container = document.getElementById('toastContainer');
      if (!container) return null;

      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ'
      };

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      let actionHtml = '';
      if (actionBtn) {
        actionHtml = `<button class="toast-action" onclick="this.closest('.toast').dataset.actionClicked='true'; (${actionBtn.callback.toString()})()">
          ${actionBtn.label}
        </button>`;
      }

      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        ${actionHtml}
      `;

      container.appendChild(toast);

      // Auto-remove after duration
      const timeoutId = setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);

      // Return toast element for potential programmatic control
      toast.dataset.timeoutId = timeoutId;
      return toast;
    }

    // Pending deletion tracker for Undo functionality
    const pendingDeletions = new Map();

    // ===== GAMIFICATION FUNCTIONS =====

    // Berechnet XP für nächstes Level
    function xpForLevel(level) {
      return level * level * 100;
    }

    // Lädt Gamification-Daten vom Server
    async function loadGamificationData() {
      try {
        // User-Profil mit XP und Level laden
        const profileResult = await apiCall('/functions/v1/auth-profile', { method: 'GET' });
        if (profileResult.success && profileResult.data) {
          gamificationData.total_xp = profileResult.data.total_xp || 0;
          gamificationData.level = profileResult.data.level || 1;
        }

        // Achievements laden (alle und verdiente)
        // TODO: Eigener Endpoint für Achievements oder in auth-profile integrieren
        // Für jetzt verwenden wir die Daten aus dem Profil

        updateGamificationUI();
      } catch (error) {
        console.error('Gamification load error:', error);
      }
    }

    // Aktualisiert die Gamification-UI
    function updateGamificationUI() {
      const level = gamificationData.level || 1;
      const totalXp = gamificationData.total_xp || 0;
      const xpForCurrentLevel = xpForLevel(level - 1);
      const xpForNextLevel = xpForLevel(level);
      const xpInCurrentLevel = totalXp - xpForCurrentLevel;
      const xpNeededForNext = xpForNextLevel - xpForCurrentLevel;
      const progressPercent = Math.min(100, Math.round((xpInCurrentLevel / xpNeededForNext) * 100));

      // UI-Elemente aktualisieren
      const levelEl = document.getElementById('userLevel');
      const currentXpEl = document.getElementById('currentXp');
      const nextLevelXpEl = document.getElementById('nextLevelXp');
      const xpBarEl = document.getElementById('xpBarProgress');

      if (levelEl) levelEl.textContent = level;
      if (currentXpEl) currentXpEl.textContent = totalXp;
      if (nextLevelXpEl) nextLevelXpEl.textContent = xpForNextLevel;
      if (xpBarEl) xpBarEl.style.width = progressPercent + '%';

      // Achievements-Preview aktualisieren
      updateAchievementsPreview();
    }

    // Zeigt die Mini-Achievements-Vorschau
    function updateAchievementsPreview() {
      const container = document.getElementById('achievementsPreview');
      if (!container) return;

      // Standard-Achievements die angezeigt werden
      const previewAchievements = [
        { code: 'first_task', icon: '✅', earned: gamificationData.total_xp >= 25 },
        { code: 'streak_3', icon: '🔥', earned: false }, // TODO: Streak prüfen
        { code: 'tasks_10', icon: '⭐', earned: gamificationData.total_xp >= 100 },
        { code: 'streak_7', icon: '💪', earned: false },
        { code: 'perfect_day', icon: '🌈', earned: false },
      ];

      container.innerHTML = previewAchievements.map(a => `
        <div class="achievement-mini ${a.earned ? 'earned' : 'locked'}"
             title="${a.code}"
             onclick="showAchievementInfo('${a.code}')">
          ${a.icon}
        </div>
      `).join('');
    }

    // Zeigt das Achievement-Popup
    function showAchievementPopup(achievement) {
      const overlay = document.getElementById('achievementOverlay');
      const popup = document.getElementById('achievementPopup');
      const iconEl = document.getElementById('achievementPopupIcon');
      const titleEl = document.getElementById('achievementPopupTitle');
      const descEl = document.getElementById('achievementPopupDesc');
      const xpEl = document.getElementById('achievementPopupXp');

      if (iconEl) iconEl.textContent = achievement.icon || '🏆';
      if (titleEl) titleEl.textContent = achievement.name || 'Achievement freigeschaltet!';
      if (descEl) descEl.textContent = achievement.description || 'Du hast etwas Tolles erreicht!';
      if (xpEl) xpEl.textContent = `+${achievement.xp_reward || 0} XP`;

      if (overlay) overlay.classList.add('show');
      if (popup) popup.classList.add('show');

      // Auto-hide nach 4 Sekunden
      setTimeout(() => hideAchievementPopup(), 4000);
    }

    // Versteckt das Achievement-Popup
    function hideAchievementPopup() {
      const overlay = document.getElementById('achievementOverlay');
      const popup = document.getElementById('achievementPopup');
      if (overlay) overlay.classList.remove('show');
      if (popup) popup.classList.remove('show');
    }

    // Zeigt Achievement-Info (für Klick auf Mini-Badge)
    function showAchievementInfo(code) {
      // TODO: Achievement-Details anzeigen
      showToast(`Achievement: ${code}`, 'info', 2000);
    }

    // Verarbeitet Gamification-Response von task-update
    function handleGamificationResponse(gamification) {
      if (!gamification) return;

      // XP und Level aktualisieren
      gamificationData.total_xp = gamification.total_xp;
      gamificationData.level = gamification.level;
      updateGamificationUI();

      // Level-Up Animation
      if (gamification.level_up) {
        const levelBadge = document.getElementById('levelBadge');
        if (levelBadge) {
          levelBadge.classList.add('level-up-flash');
          setTimeout(() => levelBadge.classList.remove('level-up-flash'), 1000);
        }
        showToast(`🎉 Level Up! Du bist jetzt Level ${gamification.level}!`, 'success', 4000);
      }

      // Neue Achievements anzeigen
      if (gamification.new_achievements && gamification.new_achievements.length > 0) {
        // Zeige jedes Achievement mit Verzögerung
        gamification.new_achievements.forEach((achievement, index) => {
          setTimeout(() => {
            showAchievementPopup(achievement);
          }, index * 2000);
        });
      }

      // XP-Toast (wenn kein Achievement)
      if (gamification.xp_earned > 0 && (!gamification.new_achievements || gamification.new_achievements.length === 0)) {
        showToast(`+${gamification.xp_earned} XP`, 'success', 1500);
      }
    }

    // ===== CONFETTI ANIMATION =====

    function showConfetti() {
      const canvas = document.getElementById('confettiCanvas');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#6366f1', '#22d3ee', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];
      const particleCount = 80;

      // Create particles
      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 15,
          vy: (Math.random() - 0.5) * 15 - 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 8 + 4,
          rotation: Math.random() * 360,
          rotationSpeed: (Math.random() - 0.5) * 10,
          gravity: 0.3,
          opacity: 1
        });
      }

      let animationFrame;
      const startTime = Date.now();
      const duration = 2000;

      function animate() {
        const elapsed = Date.now() - startTime;
        if (elapsed > duration) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          cancelAnimationFrame(animationFrame);
          return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += p.gravity;
          p.rotation += p.rotationSpeed;
          p.opacity = Math.max(0, 1 - (elapsed / duration));

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.globalAlpha = p.opacity;
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
          ctx.restore();
        });

        animationFrame = requestAnimationFrame(animate);
      }

      animate();
    }

    // ===== MOTIVATION QUOTES SYSTEM =====

    const MOTIVATION_QUOTES = [
      // Stoiker
      { text: "Du hast Macht über deinen Geist, nicht über äußere Ereignisse. Erkenne das, und du wirst Stärke finden.", author: "Marc Aurel" },
      { text: "Es ist nicht das, was dir passiert, sondern wie du darauf reagierst, was zählt.", author: "Epiktet" },
      { text: "Wer nicht zufrieden ist mit dem, was er hat, wäre auch nicht zufrieden mit dem, was er haben möchte.", author: "Seneca" },
      { text: "Der Schmerz, den du heute fühlst, ist die Stärke, die du morgen spürst.", author: "Marc Aurel" },
      { text: "Beherrsche deinen Geist oder er wird dich beherrschen.", author: "Horaz" },
      { text: "Hindernisse verschwinden nicht, aber du kannst stärker werden als sie.", author: "Marc Aurel" },

      // Moderne Vordenker
      { text: "Disziplin ist die Brücke zwischen Zielen und Erfolg.", author: "Jim Rohn" },
      { text: "Der Unterschied zwischen einem erfolgreichen Menschen und anderen ist nicht mangelnde Stärke oder Wissen, sondern mangelnder Wille.", author: "Vince Lombardi" },
      { text: "Motivation bringt dich in Gang. Gewohnheit bringt dich weiter.", author: "Jim Rohn" },
      { text: "Erfolg ist die Summe kleiner Anstrengungen, die Tag für Tag wiederholt werden.", author: "Robert Collier" },
      { text: "Tu heute etwas, wofür dein zukünftiges Ich dir danken wird.", author: "Sean Patrick Flanery" },
      { text: "Der beste Zeitpunkt zu handeln war gestern. Der zweitbeste ist jetzt.", author: "Chinesisches Sprichwort" },

      // Unternehmer & Innovatoren
      { text: "Ob du denkst, du kannst es, oder du denkst, du kannst es nicht – du hast recht.", author: "Henry Ford" },
      { text: "Die einzige Möglichkeit, großartige Arbeit zu leisten, ist zu lieben, was man tut.", author: "Steve Jobs" },
      { text: "Ich habe nicht versagt. Ich habe 10.000 Wege gefunden, die nicht funktionieren.", author: "Thomas Edison" },
      { text: "Dein wertvollster Besitz ist nicht das, was du hast, sondern wer du wirst.", author: "Jim Rohn" },
      { text: "Perfektion ist nicht erreichbar, aber wenn wir Perfektion jagen, können wir Exzellenz erreichen.", author: "Vince Lombardi" },

      // Klassiker
      { text: "Es spielt keine Rolle, wie langsam du gehst, solange du nicht stehen bleibst.", author: "Konfuzius" },
      { text: "Aus Steinen, die einem in den Weg gelegt werden, kann man Schönes bauen.", author: "Johann Wolfgang von Goethe" },
      { text: "In der Mitte von Schwierigkeiten liegen die Möglichkeiten.", author: "Albert Einstein" },
      { text: "Das Geheimnis des Vorwärtskommens ist anzufangen.", author: "Mark Twain" },
      { text: "Es ist nie zu spät, das zu werden, was man hätte sein können.", author: "George Eliot" },
      { text: "Der Wille öffnet die Türen zum Erfolg.", author: "Louis Pasteur" },

      // Mindset & Resilienz
      { text: "Stärke wächst nicht aus körperlicher Kraft, sondern aus unbeugsamen Willen.", author: "Mahatma Gandhi" },
      { text: "Der größte Ruhm liegt nicht darin, niemals zu fallen, sondern jedes Mal aufzustehen.", author: "Nelson Mandela" },
      { text: "Glaube, dass du es kannst, und du bist schon halbwegs dort.", author: "Theodore Roosevelt" },
      { text: "Die schwierigsten Momente sind oft der Wendepunkt zum Erfolg.", author: "Winston Churchill" },
      { text: "Du bist stärker, als du glaubst, und mutiger, als du denkst.", author: "A.A. Milne" },
      { text: "Jeder Tag ist eine neue Chance, das Leben zu ändern, das du führst.", author: "Jordan Peterson" },

      // Disziplin & Ausdauer
      { text: "Disziplin ist die Entscheidung zwischen dem, was du jetzt willst und dem, was du am meisten willst.", author: "Augusta F. Kantra" },
      { text: "Erfolg ist kein Zufall. Er ist harte Arbeit, Ausdauer, Lernen und Opfer.", author: "Pelé" },
      { text: "Ein Jahr von jetzt an wirst du dir wünschen, du hättest heute angefangen.", author: "Karen Lamb" },
      { text: "Die einzige Person, die du sein sollst, ist die Person, die du sein willst.", author: "Ralph Waldo Emerson" },
      { text: "Kleine tägliche Verbesserungen führen langfristig zu erstaunlichen Ergebnissen.", author: "Robin Sharma" },
      { text: "Erst wenn wir alles verlieren, sind wir frei, alles zu tun.", author: "Chuck Palahniuk" },

      // Aufmunternde
      { text: "Jeder Meister war einmal ein Anfänger. Jeder Profi war einmal ein Amateur.", author: "Robin Sharma" },
      { text: "Deine einzige Grenze bist du selbst.", author: "Unbekannt" },
      { text: "Auch der längste Weg beginnt mit dem ersten Schritt.", author: "Laotse" },
      { text: "Nicht die Stärke des Körpers zählt, sondern die Stärke des Geistes.", author: "Unbekannt" },
      { text: "Was vor uns liegt und was hinter uns liegt, ist nichts im Vergleich zu dem, was in uns liegt.", author: "Ralph Waldo Emerson" }
    ];

    function initMotivationSystem() {
      const savedTime = localStorage.getItem('aiday_last_motivation');
      if (savedTime) {
        lastMotivationTime = parseInt(savedTime, 10);
      }

      // Add touch/click event to hide bubble on tap
      const bubble = document.getElementById('motivationBubble');
      if (bubble) {
        bubble.addEventListener('click', hideMotivationBubble);
        bubble.addEventListener('touchstart', hideMotivationBubble, { passive: true });
      }

      // Also hide when touching anywhere on screen
      document.addEventListener('touchstart', function(e) {
        const bubble = document.getElementById('motivationBubble');
        if (bubble && bubble.classList.contains('show')) {
          hideMotivationBubble();
        }
      }, { passive: true });
    }

    function canShowMotivation() {
      const now = Date.now();
      return (now - lastMotivationTime) >= MOTIVATION_COOLDOWN;
    }

    function getRandomQuote() {
      const index = Math.floor(Math.random() * MOTIVATION_QUOTES.length);
      return MOTIVATION_QUOTES[index];
    }

    let motivationHideTimeout = null;

    function showMotivationQuote(triggerType, skipCooldown = false) {
      // Check cooldown only if not skipped (e.g., for task reminders)
      if (!skipCooldown && !canShowMotivation()) {
        console.log('Motivation cooldown active, skipping quote');
        return;
      }

      const bubble = document.getElementById('motivationBubble');
      if (!bubble) return;

      const quote = getRandomQuote();
      const quoteTextEl = bubble.querySelector('.quote-text');
      const quoteAuthorEl = bubble.querySelector('.quote-author');

      if (quoteTextEl) quoteTextEl.textContent = `„${quote.text}"`;
      if (quoteAuthorEl) quoteAuthorEl.textContent = `— ${quote.author}`;

      // Set class based on trigger type (mood)
      bubble.className = 'motivation-speech-bubble';
      if (triggerType === 'bad') {
        bubble.classList.add('bad');
      } else if (triggerType === 'terrible') {
        bubble.classList.add('terrible');
      } else if (triggerType === 'tasks') {
        bubble.classList.add('tasks-reminder');
      } else if (triggerType === 'great' || triggerType === 'good') {
        // Positive moods get a green gradient
        bubble.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        bubble.style.boxShadow = '0 8px 32px rgba(16, 185, 129, 0.3)';
      }
      // neutral uses default cyan gradient

      // Clear any existing timeout
      if (motivationHideTimeout) {
        clearTimeout(motivationHideTimeout);
      }

      // Show with short delay
      setTimeout(() => {
        bubble.classList.add('show');
      }, 500);

      // No auto-hide - stays until user touches the screen

      // Save timestamp (only for cooldown-relevant triggers)
      if (!skipCooldown) {
        lastMotivationTime = Date.now();
        localStorage.setItem('aiday_last_motivation', lastMotivationTime.toString());
      }
    }

    function hideMotivationBubble() {
      const bubble = document.getElementById('motivationBubble');
      if (!bubble || !bubble.classList.contains('show')) return;

      // Clear auto-hide timeout
      if (motivationHideTimeout) {
        clearTimeout(motivationHideTimeout);
        motivationHideTimeout = null;
      }

      bubble.classList.add('hiding');
      bubble.classList.remove('show');

      setTimeout(() => {
        bubble.classList.remove('hiding');
        bubble.className = 'motivation-speech-bubble';
        // Reset inline styles (for positive mood colors)
        bubble.style.background = '';
        bubble.style.boxShadow = '';
      }, 400);
    }

    function checkMoodForMotivation(mood, fromCheckin = false) {
      // After check-in: always show quote (skip cooldown)
      if (fromCheckin) {
        showMotivationQuote(mood, true); // skipCooldown = true
        return;
      }
      // From dashboard load: only show for non-positive moods with cooldown
      if (mood === 'neutral' || mood === 'bad' || mood === 'terrible') {
        showMotivationQuote(mood);
      }
    }

    function checkTasksForMotivation(tasks) {
      // Only check after 18:00
      const now = new Date();
      const hour = now.getHours();
      if (hour < 18) return;

      // Check task completion rate
      if (!tasks || tasks.length === 0) return;

      const completedCount = tasks.filter(t => t.completed).length;
      const completionRate = completedCount / tasks.length;

      // Show motivation if less than 50% completed
      if (completionRate < 0.5) {
        showMotivationQuote('tasks');
      }
    }

    // ===== MOOD FACE CLICK ANIMATION =====

    function onMoodFaceClick() {
      const moodFace = document.getElementById('moodFace');
      if (!moodFace || moodFace.classList.contains('clicking')) return;

      // Hide motivation bubble if visible
      hideMotivationBubble();

      // Get current mood from class
      const moodClasses = ['great', 'good', 'neutral', 'bad', 'terrible'];
      let currentMood = 'neutral';
      for (const mood of moodClasses) {
        if (moodFace.classList.contains(mood)) {
          currentMood = mood;
          break;
        }
      }

      // Animation duration based on mood
      const durations = {
        great: 1500,    // Dancing
        good: 1500,     // Tongue out + laugh
        neutral: 1200,  // Silly wiggle + crazy eyes
        bad: 1200,      // Wave + heart
        terrible: 1500  // Hug + hearts
      };

      // Add clicking class to trigger animation
      moodFace.classList.add('clicking');

      // Show speech bubble message above smiley
      const messages = {
        great: ['Yeaah! Party time! 🎉', 'Du rockst! 🤘', 'Weiter so! ⭐'],
        good: ['Hehe! Blechi! 😜', 'Hihi! 😄', 'Lass uns Spaß haben! 🎈'],
        neutral: ['Hey, alles wird gut! 💪', 'Kopf hoch! ☀️', 'Du schaffst das! 🌟'],
        bad: ['Ich bin für dich da! 💙', 'Das wird besser! 🌈', 'Nicht aufgeben! 💪'],
        terrible: ['Virtuelle Umarmung! 🤗', 'Du bist nicht allein! 💜', 'Ich hab dich lieb! ❤️']
      };

      const moodMessages = messages[currentMood] || messages.neutral;
      const randomMessage = moodMessages[Math.floor(Math.random() * moodMessages.length)];

      // Show speech bubble above the mood face
      const bubble = document.getElementById('moodSpeechBubble');
      if (bubble) {
        bubble.textContent = randomMessage;
        bubble.className = 'mood-speech-bubble ' + currentMood + ' show';
        setTimeout(() => {
          bubble.classList.remove('show');
        }, 2000);
      }

      // Remove clicking class after animation completes
      setTimeout(() => {
        moodFace.classList.remove('clicking');
      }, durations[currentMood] || 1200);
    }

    // ===== NAVIGATION / ZURÜCK-BUTTONS =====

    function goBackFromCheckin() {
      // Vom Check-in zurück zum Dashboard (falls bereits Daten vorhanden)
      if (appData && appData.data && appData.data.has_goals) {
        showScreen('dashboardScreen', 'back');
      } else {
        // Sonst zur Start-Seite
        window.location.href = 'start-ui.html';
      }
    }

    function goBackFromGoals() {
      // Vom Goals-Screen zurück zum Check-in oder Dashboard
      if (appData && appData.data && appData.data.checkin_done) {
        setupDashboard(appData.data);
        showScreen('dashboardScreen', 'back');
      } else {
        showScreen('checkinScreen', 'back');
      }
    }

    function goBackFromClarify() {
      // Von der Klarifizierung zurück zum Goals-Screen
      currentGoalData = null;
      pendingClarification = null;
      setupGoalsScreen();
      showScreen('goalsScreen', 'back');
    }

    function skipReview() {
      // Review überspringen und zum Check-in oder Dashboard gehen
      if (appData && appData.data && appData.data.checkin_done) {
        setupDashboard(appData.data);
        showScreen('dashboardScreen', 'back');
      } else {
        showScreen('checkinScreen', 'forward');
      }
    }

    // Generiert einen eindeutigen Idempotency-Key
    function generateIdempotencyKey() {
      return `${currentUser?.id || 'anon'}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    // API Call
    async function apiCall(endpoint, options = {}) {
      const url = SUPABASE_URL + endpoint;
      const headers = {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${accessToken}`,
        ...options.headers
      };

      // Idempotency-Key hinzufügen wenn gewünscht
      if (options.idempotencyKey) {
        headers['X-Idempotency-Key'] = options.idempotencyKey;
      }

      // Timezone-Offset automatisch zum Body hinzufügen
      let body = options.body || {};
      if (typeof body === 'object' && !Array.isArray(body)) {
        body = { ...body, timezone_offset: userTimezoneOffset };
      }

      // Timeout - Standard 60 Sekunden, kann per options.timeout überschrieben werden
      const timeoutMs = options.timeout || 60000;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const response = await fetch(url, {
          method: options.method || 'GET',
          headers,
          body: options.body ? JSON.stringify(body) : undefined,
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (response.status === 401) {
          logout();
          return { success: false, error: 'Session expired' };
        }

        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError, 'Response:', text);
          return { success: false, error: `Server-Fehler (${response.status}): ${text.substring(0, 200) || 'Keine Antwort'}` };
        }

        if (!response.ok) {
          // Extrahiere Fehlermeldung aus der Antwort
          const errorMsg = data?.error || data?.message || `HTTP ${response.status}`;
          console.error('API Error Response:', data);
          return { success: false, error: errorMsg, data };
        }

        return { success: true, data };
      } catch (error) {
        clearTimeout(timeoutId);
        console.error('API Error:', error);
        if (error.name === 'AbortError') {
          return { success: false, error: 'Zeitüberschreitung - Server antwortet nicht. Bitte versuche es erneut.' };
        }
        return { success: false, error: error.message || 'Netzwerkfehler' };
      }
    }

    // Screen Management
    let lastActiveScreen = 'dashboardScreen';
    let screenHistory = ['dashboardScreen'];

    // Screen-Reihenfolge für Navigation
    const screenOrder = [
      'dashboardScreen',
      'checkinScreen',
      'goalsScreen',
      'clarifyScreen',
      'planScreen',
      'reviewScreen',
      'progressScreen',
      'profileScreen'
    ];

    function showScreen(screenId, direction = null) {
      const currentActive = document.querySelector('.screen.active');
      if (currentActive && currentActive.id !== screenId) {
        lastActiveScreen = currentActive.id;

        // Zur History hinzufügen (wenn vorwärts navigiert wird)
        if (direction !== 'back' && !screenHistory.includes(screenId)) {
          screenHistory.push(screenId);
        }
      }

      // Animation basierend auf Richtung
      if (direction && currentActive) {
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
          // Alte Screen ausblenden
          currentActive.classList.remove('active', 'slide-in-left', 'slide-in-right');
          currentActive.classList.add(direction === 'back' ? 'slide-out-right' : 'slide-out-left');

          // Neue Screen einblenden
          setTimeout(() => {
            currentActive.classList.remove('slide-out-left', 'slide-out-right');
            currentActive.style.display = 'none';

            document.querySelectorAll('.screen').forEach(s => {
              s.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
              s.style.display = 'none';
            });

            targetScreen.style.display = 'block';
            targetScreen.classList.add('active', direction === 'back' ? 'slide-in-left' : 'slide-in-right');
          }, 250);
        }
      } else {
        document.querySelectorAll('.screen').forEach(s => {
          s.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
          s.style.display = 'none';
        });
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
          targetScreen.style.display = 'block';
          targetScreen.classList.add('active');
        }
      }

      // Header auf Loading Screen verstecken
      const globalHeader = document.getElementById('globalHeader');
      if (globalHeader) {
        globalHeader.style.display = (screenId === 'loadingScreen') ? 'none' : 'block';
      }

      // Header Navigation Button aktualisieren
      updateHeaderNavButton(screenId);
    }

    // Header Navigation Button dynamisch aktualisieren
    function updateHeaderNavButton(screenId) {
      const navText = document.getElementById('headerNavText');
      const navIcon = document.getElementById('headerNavIcon');
      if (!navText || !navIcon) return;

      // Auf dem Dashboard: "Mein Fortschritt" anzeigen
      // Auf allen anderen Screens: "Dashboard" anzeigen
      if (screenId === 'dashboardScreen') {
        navText.textContent = 'Mein Fortschritt';
        navIcon.innerHTML = `
          <line x1="12" y1="20" x2="12" y2="10"/>
          <line x1="18" y1="20" x2="18" y2="4"/>
          <line x1="6" y1="20" x2="6" y2="16"/>
        `;
      } else {
        navText.textContent = 'Dashboard';
        navIcon.innerHTML = `
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        `;
      }
    }

    // Header Navigation Button Click Handler
    function onHeaderNavClick() {
      const activeScreen = document.querySelector('.screen.active');
      if (!activeScreen) return;

      if (activeScreen.id === 'dashboardScreen') {
        // Vom Dashboard → Mein Fortschritt
        showProgressScreen();
      } else {
        // Von allen anderen Screens → Dashboard
        showScreen('dashboardScreen', 'back');
      }
    }

    // Swipe Navigation
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    const minSwipeDistance = 80;

    function initSwipeNavigation() {
      const container = document.querySelector('.container');
      if (!container) return;

      container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });
    }

    function handleSwipe() {
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;

      // Nur horizontale Swipes (ignoriere vertikale)
      if (Math.abs(diffX) < minSwipeDistance || Math.abs(diffY) > Math.abs(diffX)) {
        return;
      }

      const activeScreen = document.querySelector('.screen.active');
      if (!activeScreen) return;

      const currentScreenId = activeScreen.id;

      if (diffX > 0) {
        // Nach rechts gewischt = Zurück
        navigateBack(currentScreenId);
      } else {
        // Nach links gewischt = Vorwärts (falls möglich)
        navigateForward(currentScreenId);
      }
    }

    function navigateBack(currentScreenId) {
      // Spezifische Zurück-Navigation je nach Screen
      switch (currentScreenId) {
        case 'checkinScreen':
          goBackFromCheckin();
          break;
        case 'goalsScreen':
          goBackFromGoals();
          break;
        case 'clarifyScreen':
          goBackFromClarify();
          break;
        case 'planScreen':
          setupGoalsScreen();
          showScreen('goalsScreen', 'back');
          break;
        case 'reviewScreen':
          showScreen('dashboardScreen', 'back');
          break;
        case 'progressScreen':
          closeProgressScreen();
          break;
        case 'profileScreen':
          closeProfileScreen();
          break;
        case 'dashboardScreen':
          // Auf Dashboard - nichts tun
          break;
        default:
          showScreen('dashboardScreen', 'back');
      }
    }

    function navigateForward(currentScreenId) {
      // Vorwärts-Navigation nur in bestimmten Fällen sinnvoll
      switch (currentScreenId) {
        case 'dashboardScreen':
          // Vom Dashboard zu Check-in wenn nicht erledigt
          if (appData && appData.data && !appData.data.checkin_done) {
            showScreen('checkinScreen', 'forward');
          }
          break;
        case 'checkinScreen':
          // Vom Check-in zu Goals
          if (checkinData.mood) {
            submitCheckin();
          }
          break;
        default:
          // Keine automatische Vorwärts-Navigation
          break;
      }
    }

    // Load Daily Start
    async function loadDailyStart() {
      const result = await apiCall('/functions/v1/daily-start', { method: 'POST' });

      console.log('loadDailyStart response:', result);

      if (!result.success) {
        console.error('Failed to load daily start:', result);
        // Bei Fehler trotzdem Dashboard mit leeren Daten zeigen
        setupDashboard({
          streak: 0,
          today_tasks: [],
          longterm_goals: [],
          checkin_done: false,
          has_goals: false
        });
        showScreen('dashboardScreen');
        return;
      }

      appData = result.data;
      const step = result.data.step;

      console.log('loadDailyStart data:', {
        step,
        todayTasksCount: result.data.data?.today_tasks?.length || 0,
        todayTasks: result.data.data?.today_tasks,
        longtermGoals: result.data.data?.longterm_goals
      });

      // Nach dem Einloggen immer zuerst das Dashboard anzeigen
      setupDashboard(result.data.data);

      // Gamification-Daten laden (asynchron, nicht blockierend)
      loadGamificationData();
      showScreen('dashboardScreen');

      // Onboarding für neue User anzeigen
      if (shouldShowOnboarding()) {
        setTimeout(() => showOnboarding(), 500);
      }
      // Weekly Report am Sonntag anzeigen
      else if (shouldShowWeeklyReport()) {
        setTimeout(() => showWeeklyReport(), 1000);
      }
    }

    // Mood Selection
    function selectMood(mood) {
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-mood="${mood}"]`).classList.add('selected');
      checkinData.mood = mood;
      updateCheckinButton();
    }

    // Energy Selection
    function selectEnergy(level) {
      document.querySelectorAll('.energy-level').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-level="${level}"]`).classList.add('selected');
      checkinData.energy_level = level;
      updateCheckinButton();

      // Hide attention animation if showing
      const slider = document.getElementById('energySlider');
      const bubble = document.getElementById('energySpeechBubble');
      if (slider) slider.classList.remove('needs-attention');
      if (bubble) bubble.classList.remove('show');
    }

    // Show attention animation for mood selection
    function showMoodAttention() {
      const formGroup = document.getElementById('moodFormGroup');
      const buttons = document.getElementById('moodButtons');
      const bubble = document.getElementById('moodSpeechBubbleCheckin');

      if (buttons && bubble && formGroup) {
        // Remove and re-add class to restart animation
        buttons.classList.remove('needs-attention');
        bubble.classList.remove('show');

        // Scroll to mood form group
        formGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Trigger animation after short delay
        setTimeout(() => {
          buttons.classList.add('needs-attention');
          bubble.classList.add('show');

          // Remove animation class after completion
          setTimeout(() => {
            buttons.classList.remove('needs-attention');
          }, 1000);

          // Remove bubble after display time
          setTimeout(() => {
            bubble.classList.remove('show');
          }, 2500);
        }, 100);
      }
    }

    // Show attention animation for energy selection
    function showEnergyAttention() {
      const formGroup = document.getElementById('energyFormGroup');
      const slider = document.getElementById('energySlider');
      const bubble = document.getElementById('energySpeechBubble');

      if (slider && bubble && formGroup) {
        // Remove and re-add class to restart animation
        slider.classList.remove('needs-attention');
        bubble.classList.remove('show');

        // Scroll to energy form group
        formGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Trigger animation after short delay
        setTimeout(() => {
          slider.classList.add('needs-attention');
          bubble.classList.add('show');

          // Remove animation class after completion
          setTimeout(() => {
            slider.classList.remove('needs-attention');
          }, 1000);

          // Remove bubble after display time
          setTimeout(() => {
            bubble.classList.remove('show');
          }, 2500);
        }, 100);
      }
    }

    function updateCheckinButton() {
      // Button ist nicht mehr disabled, aber wir prüfen beim Submit
      const btn = document.getElementById('checkinSubmit');
      if (btn) btn.disabled = false;
    }

    // Submit Check-in
    async function submitCheckin() {
      // Check if mood is selected
      if (!checkinData.mood) {
        showMoodAttention();
        return;
      }

      // Check if energy level is selected
      if (!checkinData.energy_level) {
        showEnergyAttention();
        return;
      }

      const btn = document.getElementById('checkinSubmit');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Wird gespeichert...';

      try {
        const body = {
          mood: checkinData.mood,
          mood_note: document.getElementById('moodNote').value,
          planned_today: document.getElementById('plannedToday').value,
          energy_level: checkinData.energy_level
        };

        const result = await apiCall('/functions/v1/daily-checkin', {
          method: 'POST',
          body
        });

        if (result.success) {
          btn.textContent = 'Gespeichert!';
          showToast('Check-in erfolgreich!', 'success', 2000);

          // Save mood for motivation quote (will be shown on progress screen)
          pendingMotivationMood = checkinData.mood;

          // Short delay to show success
          setTimeout(() => {
            // Check if we need to setup goals (at least 1 required)
            if (appData?.data?.goals_count === 0) {
              setupGoalsScreen();
              showScreen('goalsScreen', 'forward');
            } else {
              loadDailyStart();
            }
            // Reset button for next time
            btn.disabled = false;
            btn.textContent = originalText;
          }, 500);
        } else {
          btn.disabled = false;
          btn.textContent = originalText;
          showToast('Fehler beim Speichern: ' + (result.error || 'Unbekannter Fehler'), 'error');
        }
      } catch (error) {
        console.error('submitCheckin error:', error);
        btn.disabled = false;
        btn.textContent = originalText;
        showToast('Fehler beim Speichern: ' + (error.message || 'Unbekannter Fehler'), 'error');
      }
    }

    // Goals Setup
    let currentGoalData = null;
    let pendingClarification = null;

    function setupGoalsScreen() {
      goals = [];
      currentGoalData = null;
      pendingClarification = null;
      clearGoalForm();
      updateGoalUI();
    }

    function clearGoalForm() {
      document.getElementById('goalTitle').value = '';
      document.getElementById('goalWhy').value = '';
      document.getElementById('goalPrevious').value = '';
      document.getElementById('goalSteps').value = '';
    }

    function updateGoalUI() {
      const goalNum = goals.length + 1;
      document.getElementById('goalNumber').textContent = `Ziel ${goalNum}`;

      const subtitle = document.getElementById('goalSubtitle');
      if (goals.length === 0) {
        subtitle.textContent = 'Was möchtest du erreichen?';
      } else {
        subtitle.textContent = 'Definiere ein weiteres Ziel (optional)';
      }

      // Show add button only after first goal is added (kein Limit mehr)
      document.getElementById('goalAdd').style.display = goals.length > 0 ? 'block' : 'none';

      // Update submit button text
      const submitBtn = document.getElementById('goalSubmit');
      if (goals.length === 0) {
        submitBtn.textContent = 'Weiter';
      } else {
        submitBtn.textContent = `Plan für ${goals.length} Ziel${goals.length > 1 ? 'e' : ''} erstellen`;
      }

      renderSavedGoals();
    }

    function renderSavedGoals() {
      const container = document.getElementById('savedGoalsList');
      if (goals.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = `
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Deine Ziele:</div>
        ${goals.map((goal, idx) => `
          <div class="goal-list-item" onclick="showGoalPreview(${idx})">
            <div class="goal-list-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div>
            <div class="goal-list-content">
              <div class="goal-list-title">${goal.title}</div>
              <div class="goal-list-meta">${goal.why_important ? goal.why_important.substring(0, 50) + (goal.why_important.length > 50 ? '...' : '') : 'Tippen für Details'}</div>
            </div>
            <button onclick="event.stopPropagation(); removeGoal(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 8px; font-size: 16px;">✕</button>
          </div>
        `).join('')}
      `;
    }

    // Show preview of a goal during setup (before plan is created)
    function showGoalPreview(idx) {
      const goal = goals[idx];
      if (!goal) return;

      document.getElementById('goalDetailTitle').textContent = goal.title;
      document.getElementById('goalDetailStatus').textContent = 'Entwurf';
      document.getElementById('goalDetailStatus').style.background = 'var(--warning)';
      document.getElementById('goalDetailStatus').style.color = '#fff';

      // Progress (none yet)
      document.getElementById('goalDetailProgress').innerHTML = `
        <div class="progress-container">
          <div class="progress-label">
            <span>Plan wird erstellt...</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      `;

      // Info
      document.getElementById('goalDetailInfo').innerHTML = `
        <div class="goal-detail-section">
          <div class="goal-detail-section-title">Details</div>
          ${goal.why_important ? `
            <div class="goal-info-item">
              <div class="goal-info-label">Motivation</div>
              <div class="goal-info-value">${goal.why_important}</div>
            </div>
          ` : ''}
          ${goal.previous_efforts ? `
            <div class="goal-info-item">
              <div class="goal-info-label">Bisherige Versuche</div>
              <div class="goal-info-value">${goal.previous_efforts}</div>
            </div>
          ` : ''}
          ${goal.believed_steps ? `
            <div class="goal-info-item">
              <div class="goal-info-label">Eigene Ideen</div>
              <div class="goal-info-value">${goal.believed_steps}</div>
            </div>
          ` : ''}
          ${!goal.why_important && !goal.previous_efforts && !goal.believed_steps ? `
            <p style="color: var(--text-muted); font-size: 14px;">Noch keine Details angegeben.</p>
          ` : ''}
        </div>
      `;

      // Milestones (none yet)
      document.getElementById('goalDetailMilestones').innerHTML = `
        <div class="goal-detail-section">
          <div class="goal-detail-section-title">Meilensteine</div>
          <p style="color: var(--text-muted); font-size: 14px;">Werden nach Plan-Erstellung angezeigt.</p>
        </div>
      `;

      // Tasks (none yet)
      document.getElementById('goalDetailTasks').innerHTML = `
        <div class="goal-detail-section">
          <div class="goal-detail-section-title">Tägliche Aufgaben</div>
          <p style="color: var(--text-muted); font-size: 14px;">Werden nach Plan-Erstellung angezeigt.</p>
        </div>
      `;

      previousScreen = 'goalsScreen';
      showScreen('goalDetailScreen');
    }

    function removeGoal(idx) {
      goals.splice(idx, 1);
      updateGoalUI();
    }

    function getCurrentGoalFormData() {
      return {
        title: document.getElementById('goalTitle').value.trim(),
        why_important: document.getElementById('goalWhy').value,
        previous_efforts: document.getElementById('goalPrevious').value,
        believed_steps: document.getElementById('goalSteps').value,
        clarification_answers: {}
      };
    }

    // Check if goal needs clarification before proceeding
    async function checkGoalAndProceed() {
      const goalData = getCurrentGoalFormData();

      if (!goalData.title) {
        showToast('Bitte gib ein Ziel ein.', 'warning');
        return;
      }

      currentGoalData = goalData;

      const btn = document.getElementById('goalSubmit');
      btn.disabled = true;
      btn.textContent = 'Analysiere...';

      // Call API to check if clarification is needed
      const result = await apiCall('/functions/v1/goal-clarify', {
        method: 'POST',
        body: {
          goal_title: goalData.title,
          why_important: goalData.why_important,
          previous_efforts: goalData.previous_efforts,
          believed_steps: goalData.believed_steps
        },
        timeout: 90000 // 90 Sekunden für AI
      });

      btn.disabled = false;
      btn.textContent = goals.length === 0 ? 'Weiter' : `Plan für ${goals.length} Ziel${goals.length > 1 ? 'e' : ''} erstellen`;

      if (result.success && result.data.questions?.length > 0) {
        // Always show clarification screen if we have questions
        pendingClarification = result.data;
        showClarificationScreen(goalData.title, result.data);
      } else if (result.success) {
        // No questions returned - use generic fallback questions
        const fallbackData = {
          needs_clarification: true,
          reason: 'Um dir den besten Plan zu erstellen, brauche ich noch ein paar Details.',
          goal_type: 'other',
          questions: [
            { id: 'success_definition', question: 'Woran erkennst du, dass du das Ziel erreicht hast?', placeholder: 'z.B. Konkretes Ergebnis, Gefühl, Zahl...' },
            { id: 'current_state', question: 'Wie ist dein aktueller Stand?', placeholder: 'z.B. Ganz am Anfang, schon angefangen...' },
            { id: 'available_time', question: 'Wie viel Zeit kannst du täglich investieren?', placeholder: 'z.B. 30 Min, 1 Stunde...' },
            { id: 'biggest_obstacle', question: 'Was ist dein größtes Hindernis?', placeholder: 'z.B. Zeit, Motivation, Wissen...' }
          ]
        };
        pendingClarification = fallbackData;
        showClarificationScreen(goalData.title, fallbackData);
      } else {
        // API error - just add goal without clarification
        goals.push(currentGoalData);
        clearGoalForm();
        currentGoalData = null;
        updateGoalUI();
        showPostGoalOptions();
      }
    }

    function showClarificationScreen(goalTitle, clarifyData) {
      document.getElementById('clarifyGoalTitle').textContent = `"${goalTitle}"`;
      document.getElementById('clarifyReason').textContent = clarifyData.reason || 'Um dir einen personalisierten Plan zu erstellen, brauche ich noch ein paar Details.';

      // Show goal type badge
      const goalTypeLabels = {
        financial: '💰 Finanzielles Ziel',
        fitness: '🏃 Fitness & Gesundheit',
        learning: '📚 Lernziel',
        career: '💼 Karriereziel',
        personal: '🎯 Persönliches Ziel',
        other: '🎯 Dein Ziel'
      };
      const goalTypeLabel = goalTypeLabels[clarifyData.goal_type] || goalTypeLabels.other;

      const container = document.getElementById('clarifyQuestions');
      container.innerHTML = `
        <div style="margin-bottom: 20px; padding: 12px; background: var(--accent-glow); border-radius: 10px; text-align: center;">
          <span style="font-size: 14px;">${goalTypeLabel}</span>
        </div>
        ${clarifyData.questions.map(q => `
          <div class="form-group">
            <label class="form-label">${q.question}</label>
            <input type="text" class="form-input" id="clarify-${q.id}" placeholder="${q.placeholder || ''}">
          </div>
        `).join('')}
      `;

      // Reset clarify button
      const clarifyBtn = document.getElementById('clarifySubmit');
      if (clarifyBtn) {
        clarifyBtn.disabled = false;
        clarifyBtn.textContent = 'Plan erstellen lassen';
      }

      showScreen('clarifyScreen', 'forward');
    }

    function submitClarification() {
      if (!pendingClarification || !currentGoalData) return;

      // Show loading state on button
      const btn = document.getElementById('clarifySubmit');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Plan wird erstellt...';
      }

      // Collect answers
      const answers = {};
      pendingClarification.questions.forEach(q => {
        const input = document.getElementById(`clarify-${q.id}`);
        if (input && input.value.trim()) {
          answers[q.id] = input.value.trim();
        }
      });

      // Add answers to goal data
      currentGoalData.clarification_answers = answers;

      // Build context string from answers for the goal
      const contextParts = [];
      pendingClarification.questions.forEach(q => {
        if (answers[q.id]) {
          contextParts.push(`${q.question}: ${answers[q.id]}`);
        }
      });

      if (contextParts.length > 0) {
        // Append clarification context to previous_efforts or believed_steps
        const clarificationContext = '\n\n--- Zusätzliche Details ---\n' + contextParts.join('\n');
        currentGoalData.believed_steps = (currentGoalData.believed_steps || '') + clarificationContext;
      }

      // Add goal and continue
      goals.push(currentGoalData);
      clearGoalForm();
      currentGoalData = null;
      pendingClarification = null;
      updateGoalUI();
      showPostGoalOptions();
    }

    function skipClarification() {
      if (currentGoalData) {
        goals.push(currentGoalData);
        clearGoalForm();
        currentGoalData = null;
      }
      pendingClarification = null;
      updateGoalUI();
      showPostGoalOptions();
    }

    function showPostGoalOptions() {
      // Nach Klarifizierung direkt Plan erstellen (kein Dialog mehr)
      submitGoals();
    }

    function addAnotherGoal() {
      // This is called when user wants to add another goal after already having some
      const goalData = getCurrentGoalFormData();

      if (!goalData.title) {
        // No new goal entered, just submit existing goals
        submitGoals();
        return;
      }

      // Check clarification for this goal
      checkGoalAndProceed();
    }

    async function submitGoals() {
      // Check if there's a current goal being entered that wasn't added yet
      const currentFormData = getCurrentGoalFormData();
      if (currentFormData.title && !goals.find(g => g.title === currentFormData.title)) {
        // There's a new goal - check clarification first
        await checkGoalAndProceed();
        return;
      }

      if (goals.length === 0) {
        showToast('Bitte gib mindestens ein Ziel ein.', 'warning');
        return;
      }

      const btn = document.getElementById('goalSubmit');
      btn.disabled = true;
      btn.textContent = 'KI erstellt Plan...';

      showScreen('loadingScreen');
      document.querySelector('.loading-text').textContent = 'Dein persönlicher Plan wird erstellt...';

      // Idempotency-Key verhindert doppelte Einträge bei erneutem Absenden
      const idempotencyKey = generateIdempotencyKey();

      const result = await apiCall('/functions/v1/goals-setup', {
        method: 'POST',
        body: { goals },
        timeout: 120000, // 2 Minuten für AI-Plan-Generierung
        idempotencyKey: idempotencyKey
      });

      if (result.success) {
        displayAIPlan(result.data);
        showScreen('planScreen', 'forward');
      } else {
        btn.disabled = false;
        btn.textContent = 'Plan erstellen';
        showScreen('goalsScreen', 'back');
        showToast('Fehler: ' + (result.error || 'Unbekannter Fehler'), 'error');
      }
    }

    // Display AI Plan - New format with timeline
    let currentPlanData = null;

    function displayAIPlan(data) {
      currentPlanData = data; // Store for accept/reject
      const container = document.getElementById('planCards');
      container.innerHTML = '';

      const plans = data.ai_plan?.plans || [];

      plans.forEach((plan, idx) => {
        const goal = data.goals?.[idx];
        const card = document.createElement('div');
        card.className = 'card ai-plan-card';

        // Format target date
        const targetDate = plan.target_date ? new Date(plan.target_date) : null;
        const targetDateStr = targetDate ? targetDate.toLocaleDateString('de-DE', { day: 'numeric', month: 'long', year: 'numeric' }) : '';

        card.innerHTML = `
          <div class="plan-header">
            <div class="plan-duration">${plan.duration_weeks || 12} Wochen</div>
            <div class="plan-target-date">Ziel: ${targetDateStr}</div>
          </div>

          <h3 style="margin-bottom: 12px; font-size: 18px;">${goal?.title || 'Ziel ' + (idx + 1)}</h3>
          <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 16px;">${plan.analysis || ''}</p>

          ${plan.success_metric ? `
          <div style="background: var(--accent-glow); padding: 10px 14px; border-radius: 10px; margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--text-muted);">Erfolgskriterium:</div>
            <div style="font-weight: 600; color: var(--accent);">${plan.success_metric}</div>
          </div>
          ` : ''}

          ${plan.milestones?.length ? `
          <div class="plan-section">
            <div class="plan-section-title">Meilensteine:</div>
            <div class="milestone-timeline">
              ${plan.milestones.map(m => `
                <div class="milestone-item">
                  <div class="milestone-week">Woche ${m.week}</div>
                  <div class="milestone-target">${m.target}</div>
                  ${m.metric ? `<div class="milestone-metric">${m.metric}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}

          ${plan.daily_tasks?.length ? `
          <div class="plan-section">
            <div class="plan-section-title">Deine täglichen Aufgaben:</div>
            ${plan.daily_tasks.map(t => `
              <div class="daily-task-item-detailed">
                <div class="task-header">
                  <div class="task-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                  <div class="task-info">
                    <div class="task-name">${t.task}</div>
                    <div class="task-meta">
                      <span class="task-duration">${t.duration_minutes} Min.</span>
                      <span class="task-time">${t.best_time ? (t.best_time === 'morgens' ? '🌅 Morgens' : t.best_time === 'mittags' ? '☀️ Mittags' : t.best_time === 'abends' ? '🌙 Abends' : '⏰ Flexibel') : ''}</span>
                    </div>
                  </div>
                </div>
                ${t.why ? `<div class="task-why"><strong>Warum:</strong> ${t.why}</div>` : ''}
                ${t.steps?.length ? `
                <div class="task-steps">
                  <div class="task-steps-title">So geht's:</div>
                  <ol class="task-steps-list">
                    ${t.steps.map(step => `<li>${step}</li>`).join('')}
                  </ol>
                </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          ` : ''}

          ${plan.weekly_tasks?.length ? `
          <div class="plan-section">
            <div class="plan-section-title">Wöchentliche Aufgaben:</div>
            <ul class="plan-steps">
              ${plan.weekly_tasks.map(t => `<li>${t}</li>`).join('')}
            </ul>
          </div>
          ` : ''}

          ${plan.motivation ? `
          <div style="font-style: italic; color: var(--accent); margin-top: 16px; padding: 12px; background: var(--accent-glow); border-radius: 10px;">
            "${plan.motivation}"
          </div>
          ` : ''}
        `;
        container.appendChild(card);
      });
    }

    async function acceptPlan() {
      if (!currentPlanData) {
        console.error('acceptPlan: No currentPlanData available');
        showToast('Fehler: Keine Plandaten vorhanden. Bitte versuche es erneut.', 'error');
        return;
      }

      const btn = document.getElementById('acceptPlanBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Wird gespeichert...';

      try {
        // Accept each plan
        const plans = currentPlanData.ai_plan?.plans || [];
        const goalsData = currentPlanData.goals || [];

        console.log('acceptPlan called with:', {
          plansCount: plans.length,
          goalsCount: goalsData.length,
          plans,
          goalsData
        });

        if (plans.length === 0) {
          throw new Error('Keine Pläne zum Speichern vorhanden');
        }

        let successCount = 0;
        let lastError = null;

        for (let i = 0; i < plans.length; i++) {
          const plan = plans[i];
          const goal = goalsData[i];
          if (!goal?.id || !plan) {
            console.log('Skipping plan', i, '- no goal or plan:', { goal, plan });
            continue;
          }

          const requestBody = {
            goal_id: goal.id,
            plan: {
              duration_weeks: plan.duration_weeks || 12,
              target_date: plan.target_date || new Date(Date.now() + 84*24*60*60*1000).toISOString().split('T')[0],
              milestones: plan.milestones || [],
              daily_tasks: plan.daily_tasks || [],
              weekly_tasks: plan.weekly_tasks || [],
              success_metric: plan.success_metric || ''
            }
          };

          console.log('Sending accept-plan request:', requestBody);

          const result = await apiCall('/functions/v1/accept-plan', {
            method: 'POST',
            body: requestBody
          });

          console.log('accept-plan response:', result);

          if (result.error) {
            console.error('accept-plan error for goal', goal.id, ':', result.error);
            lastError = result.error;
          } else {
            successCount++;
          }
        }

        if (successCount === 0 && lastError) {
          throw new Error(lastError);
        }

        console.log('Plans accepted successfully:', successCount);

        // Success! Show confirmation and go to dashboard
        currentPlanData = null;
        btn.textContent = 'Gespeichert!';
        showToast('Plan akzeptiert! Deine Aufgaben wurden erstellt.', 'success', 3000);

        // Short delay to show success, then load dashboard
        setTimeout(async () => {
          try {
            await loadDailyStart();
          } catch (e) {
            console.error('loadDailyStart error:', e);
            // Fallback: just show dashboard
            showScreen('dashboardScreen');
          }
        }, 500);

      } catch (error) {
        console.error('acceptPlan error:', error);
        showToast('Fehler beim Speichern des Plans: ' + (error.message || 'Unbekannter Fehler'), 'error');

        // Reset button
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function rejectPlan() {
      // Go back to dashboard
      currentPlanData = null;
      goals = [];
      loadDailyStart();
    }

    // Dashboard
    function showDashboard() {
      loadDailyStart();
    }

    function setupDashboard(data) {
      // Today's tasks
      const tasksEl = document.getElementById('todayTasks');
      const tasks = data.today_tasks || [];

      // Update Tasks Badge
      const tasksBadgeEl = document.getElementById('tasksBadge');
      if (tasksBadgeEl) {
        const completedTasks = tasks.filter(t => t.completed).length;
        tasksBadgeEl.textContent = `${completedTasks}/${tasks.length}`;
      }

      // Goals List
      const goalsList = data.longterm_goals || [];

      if (tasks.length === 0) {
        tasksEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
            <div class="empty-state-title">Bereit für neue Aufgaben!</div>
            <p>Definiere ein Ziel, um deine ersten Aufgaben zu erhalten.</p>
            <button class="empty-state-btn" onclick="editGoals()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Ziel erstellen
            </button>
          </div>
        `;
      } else {
        tasksEl.innerHTML = tasks.map(task => {
          const details = task.task_details || {};
          const timeIcon = {'morgens': '🌅', 'mittags': '☀️', 'abends': '🌙'}[details.best_time] || '';
          const timeLabel = details.best_time ? details.best_time.charAt(0).toUpperCase() + details.best_time.slice(1) : '';
          const duration = task.estimated_minutes || 15;
          return `
          <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" onclick="showTaskDetail('${task.id}')">
            <div class="task-checkbox">${task.completed ? '✓' : ''}</div>
            <div class="task-content">
              <div class="task-text">${task.task_text}</div>
              <div class="task-meta">
                <span class="task-meta-item">⏱️ ${duration} Min</span>
                ${timeIcon ? `<span class="task-meta-item">${timeIcon} ${timeLabel}</span>` : ''}
              </div>
            </div>
            <div class="task-arrow">›</div>
          </div>
        `}).join('');
      }

      // Goals with Progress
      const goalsEl = document.getElementById('goalsProgressList');
      // goalsList wurde bereits oben definiert

      // Store goals for detail view
      window.dashboardGoals = goalsList;

      if (goalsList.length === 0) {
        goalsEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
              </svg>
            </div>
            <div class="empty-state-title">Setze dir ein Ziel!</div>
            <p>Mit einem klaren Ziel beginnt jede Reise. Was möchtest du erreichen?</p>
            <button class="empty-state-btn" onclick="editGoals()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Ziel definieren
            </button>
          </div>
        `;
      } else {
        goalsEl.innerHTML = goalsList.map((goal, idx) => {
          const hasProgress = goal.target_date && goal.days_left !== null;
          const plan = goal.plan;
          const milestones = plan?.milestones || [];

          // Find current milestone (first one not yet reached based on time)
          let currentMilestoneIdx = 0;
          if (milestones.length > 0 && goal.progress_percent !== null) {
            const progressWeeks = Math.floor((goal.progress_percent / 100) * (plan?.duration_weeks || 12));
            currentMilestoneIdx = milestones.findIndex(m => m.week > progressWeeks);
            if (currentMilestoneIdx === -1) currentMilestoneIdx = milestones.length - 1;
          }

          const targetDateStr = goal.target_date
            ? new Date(goal.target_date).toLocaleDateString('de-DE', { day: 'numeric', month: 'short' })
            : '';

          return `
            <div class="goal-progress-card" onclick="showGoalDetail(window.dashboardGoals[${idx}])" style="cursor: pointer;">
              <div class="goal-progress-header">
                <div class="goal-progress-title">${goal.title}</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div class="goal-progress-badge">${goal.status === 'in_progress' ? 'Aktiv' : goal.status || 'Offen'}</div>
                  <span style="color: var(--text-muted);">›</span>
                </div>
              </div>

              ${hasProgress ? `
                <div class="progress-container">
                  <div class="progress-label">
                    <span>${goal.progress_percent}% geschafft</span>
                    <span>Ziel: ${targetDateStr}</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill" style="width: ${goal.progress_percent}%"></div>
                  </div>
                </div>
                <div class="goal-days-left">
                  ${goal.days_left === 0
                    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg> Heute ist der Zieltag!'
                    : goal.days_left === 1
                      ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Noch 1 Tag übrig'
                      : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Noch ${goal.days_left} Tage übrig`}
                </div>
              ` : ''}

              ${milestones.length > 0 ? `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--glass-border);">
                  <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Nächster Meilenstein:</div>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%;"></div>
                    <div>
                      <div style="font-size: 14px; font-weight: 500;">${milestones[currentMilestoneIdx]?.target || ''}</div>
                      <div style="font-size: 12px; color: var(--text-muted);">Woche ${milestones[currentMilestoneIdx]?.week || ''} ${milestones[currentMilestoneIdx]?.metric ? `• ${milestones[currentMilestoneIdx].metric}` : ''}</div>
                    </div>
                  </div>
                </div>
              ` : ''}

              <div style="margin-top: 12px; font-size: 12px; color: var(--accent);">
                Tippen für Details und Aufgaben →
              </div>
            </div>
          `;
        }).join('');
      }

      // Check for motivation quote (evening reminder for incomplete tasks)
      checkTasksForMotivation(tasks);
    }

    // Debug function to reset cooldown and test motivation quotes
    function testMotivationQuote(mood = 'bad') {
      lastMotivationTime = 0;
      localStorage.removeItem('aiday_last_motivation');
      showMotivationQuote(mood);
    }

    async function toggleTask(taskId, completed) {
      // Optimistic update - Alle Task-Elemente (Dashboard + Progress-Screen)
      const taskElements = document.querySelectorAll(`[data-task-id="${taskId}"]`);
      taskElements.forEach(taskEl => {
        taskEl.classList.toggle('completed', completed);
        const checkbox = taskEl.querySelector('.task-checkbox, .progress-task-checkbox');
        if (checkbox) checkbox.textContent = completed ? '✓' : '';
      });

      // Optimistic update - Progress Indicators
      updateTaskProgress(completed ? 1 : -1);

      // API call to update
      const action = completed ? 'complete' : 'uncomplete';
      const result = await apiCall('/functions/v1/task-update', {
        method: 'POST',
        body: { task_id: taskId, action }
      });

      if (!result.success) {
        // Revert on error - Alle Elemente zurücksetzen
        taskElements.forEach(taskEl => {
          taskEl.classList.toggle('completed', !completed);
          const checkbox = taskEl.querySelector('.task-checkbox, .progress-task-checkbox');
          if (checkbox) checkbox.textContent = completed ? '' : '✓';
        });
        // Revert progress
        updateTaskProgress(completed ? -1 : 1);
        console.error('Failed to update task:', result.error);
        showToast('Fehler beim Aktualisieren der Aufgabe', 'error');
      } else if (completed) {
        // Gamification-Response verarbeiten
        if (result.data?.gamification) {
          handleGamificationResponse(result.data.gamification);
        } else {
          // Fallback: Einfacher Success-Toast wenn keine Gamification-Daten
          showToast('Aufgabe erledigt!', 'success', 2000);
        }

        // Check if all tasks are completed
        const allTasks = document.querySelectorAll('.task-item, .progress-task-item');
        const completedTasks = document.querySelectorAll('.task-item.completed, .progress-task-item.completed');
        if (allTasks.length > 0 && allTasks.length === completedTasks.length) {
          setTimeout(() => {
            showConfetti();
            showToast('🎉 Alle Aufgaben erledigt! Fantastisch!', 'success', 4000);
          }, 300);
        }
      }
    }

    // Task Detail Functions
    function generateTaskGuidance(taskText) {
      // Generiere hilfreiche Anleitungen basierend auf Schlüsselwörtern
      const text = taskText.toLowerCase();

      // Entspannung / Meditation / Schlaf
      if (text.includes('entspannung') || text.includes('meditation') || text.includes('schlaf') || text.includes('ruhe')) {
        return {
          why: 'Regelmäßige Entspannung reduziert Stress, verbessert die Schlafqualität und steigert deine mentale Klarheit. Schon wenige Minuten täglich können einen großen Unterschied machen.',
          steps: [
            'Finde einen ruhigen Ort ohne Ablenkungen',
            'Setze oder lege dich bequem hin',
            'Schließe die Augen und atme 5x tief ein und aus',
            'Konzentriere dich auf deinen Körper - entspanne jeden Muskel von den Füßen bis zum Kopf',
            'Bleibe 5-10 Minuten in diesem entspannten Zustand'
          ]
        };
      }

      // Sport / Bewegung / Training
      if (text.includes('sport') || text.includes('training') || text.includes('bewegung') || text.includes('laufen') || text.includes('fitness') || text.includes('übung')) {
        return {
          why: 'Körperliche Aktivität stärkt nicht nur deinen Körper, sondern auch deinen Geist. Sport setzt Endorphine frei und gibt dir mehr Energie für den Tag.',
          steps: [
            'Ziehe bequeme Sportkleidung an',
            'Wärme dich 5 Minuten auf (Dehnen, leichtes Gehen)',
            'Führe die geplante Aktivität in deinem Tempo durch',
            'Achte auf deine Atmung und höre auf deinen Körper',
            'Cool-down: 5 Minuten auslaufen und dehnen'
          ]
        };
      }

      // Lernen / Lesen / Studieren
      if (text.includes('lern') || text.includes('les') || text.includes('studi') || text.includes('buch') || text.includes('kurs')) {
        return {
          why: 'Kontinuierliches Lernen hält deinen Geist scharf und eröffnet neue Möglichkeiten. Kleine, regelmäßige Lerneinheiten sind effektiver als lange Marathons.',
          steps: [
            'Schalte alle Benachrichtigungen aus',
            'Bereite dein Lernmaterial vor',
            'Setze dir ein kleines, konkretes Lernziel für heute',
            'Lerne in 25-Minuten-Blöcken mit kurzen Pausen (Pomodoro)',
            'Fasse das Gelernte kurz in eigenen Worten zusammen'
          ]
        };
      }

      // Arbeit / Projekt / Aufgabe
      if (text.includes('arbeit') || text.includes('projekt') || text.includes('aufgabe') || text.includes('erledige') || text.includes('fertig')) {
        return {
          why: 'Das Abschließen von Aufgaben gibt dir ein Erfolgserlebnis und reduziert mentale Last. Jeder kleine Fortschritt bringt dich deinem Ziel näher.',
          steps: [
            'Definiere klar, was "fertig" für diese Aufgabe bedeutet',
            'Teile die Aufgabe in kleine, machbare Schritte auf',
            'Beginne mit dem einfachsten Schritt',
            'Arbeite fokussiert ohne Multitasking',
            'Feiere den Abschluss und mache eine kurze Pause'
          ]
        };
      }

      // Ernährung / Essen / Kochen
      if (text.includes('ess') || text.includes('ernährung') || text.includes('koch') || text.includes('mahl') || text.includes('trink') || text.includes('wasser')) {
        return {
          why: 'Gute Ernährung ist die Basis für Energie und Wohlbefinden. Was du isst, beeinflusst direkt deine Leistungsfähigkeit und Stimmung.',
          steps: [
            'Plane deine Mahlzeit bewusst im Voraus',
            'Wähle frische, nährstoffreiche Zutaten',
            'Nimm dir Zeit zum Essen ohne Ablenkung',
            'Kaue gründlich und genieße jeden Bissen',
            'Trinke ein Glas Wasser dazu'
          ]
        };
      }

      // Bildschirm / Digital Detox / Handy
      if (text.includes('bildschirm') || text.includes('handy') || text.includes('digital') || text.includes('social') || text.includes('internet')) {
        return {
          why: 'Bildschirmpausen geben deinen Augen und deinem Gehirn Erholung. Weniger Bildschirmzeit vor dem Schlafen verbessert nachweislich die Schlafqualität.',
          steps: [
            'Stelle einen Timer für das Ende deiner Bildschirmzeit',
            'Lege alle Geräte außer Reichweite',
            'Finde eine alternative Aktivität (Lesen, Spazieren, Gespräch)',
            'Wenn du Langeweile spürst - das ist normal und gut!',
            'Genieße die Zeit ohne digitale Reize'
          ]
        };
      }

      // Sozial / Familie / Freunde
      if (text.includes('freund') || text.includes('familie') || text.includes('ruf an') || text.includes('treff') || text.includes('kontakt')) {
        return {
          why: 'Soziale Verbindungen sind essentiell für unser Wohlbefinden. Ein kurzer Austausch mit wichtigen Menschen kann den ganzen Tag positiv beeinflussen.',
          steps: [
            'Überlege, wen du lange nicht gesprochen hast',
            'Wähle den passenden Kommunikationsweg (Anruf, Nachricht, Treffen)',
            'Stelle offene Fragen und höre aktiv zu',
            'Teile auch etwas von dir selbst',
            'Vereinbare ggf. einen nächsten Kontakt'
          ]
        };
      }

      // Planung / Organisation / Ziele
      if (text.includes('plan') || text.includes('organis') || text.includes('ziel') || text.includes('überleg') || text.includes('reflekt')) {
        return {
          why: 'Regelmäßige Planung und Reflexion geben dir Klarheit und Richtung. Du behältst den Überblick und triffst bessere Entscheidungen.',
          steps: [
            'Nimm dir Stift und Papier oder öffne deine Notizen',
            'Schreibe alle Gedanken ungefiltert auf',
            'Sortiere nach Wichtigkeit und Dringlichkeit',
            'Wähle die 1-3 wichtigsten nächsten Schritte',
            'Trage feste Zeiten für diese Schritte ein'
          ]
        };
      }

      // Standard-Anleitung für alle anderen
      return {
        why: 'Diese Aufgabe bringt dich einen Schritt näher an dein Ziel. Jede kleine Handlung zählt und baut Momentum auf.',
        steps: [
          'Lies die Aufgabe nochmal und verstehe, was zu tun ist',
          'Bereite alles vor, was du brauchst',
          'Setze dir einen Timer für fokussierte Arbeit',
          'Beginne mit dem ersten kleinen Schritt',
          'Hake die Aufgabe ab und sei stolz auf dich!'
        ]
      };
    }

    function showTaskDetail(taskId) {
      // Task-Daten aus appData finden
      const tasks = appData?.data?.today_tasks || [];
      const task = tasks.find(t => t.id === taskId);

      if (!task) {
        showToast('Aufgabe nicht gefunden', 'error');
        return;
      }

      currentTaskDetail = task;
      taskDetailPreviousScreen = document.querySelector('.screen.active')?.id || 'dashboardScreen';

      // UI befüllen
      const details = task.task_details || {};
      const timeIcons = {
        'morgens': '🌅',
        'mittags': '☀️',
        'abends': '🌙',
        'flexibel': '⏰'
      };

      document.getElementById('taskDetailTitle').textContent = task.task_text;
      document.getElementById('taskDetailTime').textContent =
        `${timeIcons[details.best_time] || '⏰'} ${(details.best_time || 'flexibel').charAt(0).toUpperCase() + (details.best_time || 'flexibel').slice(1)}`;
      document.getElementById('taskDetailDuration').textContent =
        `~${task.estimated_minutes || 15} Min`;

      // Generiere Anleitungen wenn keine Details vorhanden
      const guidance = (!details.why && (!details.steps || details.steps.length === 0))
        ? generateTaskGuidance(task.task_text)
        : null;

      // Why-Section
      const whyEl = document.getElementById('taskDetailWhy');
      const whyText = details.why || (guidance ? guidance.why : null);
      if (whyText) {
        whyEl.innerHTML = `<strong>💡 Warum diese Aufgabe?</strong><p>${whyText}</p>`;
        whyEl.style.display = 'block';
      } else {
        whyEl.style.display = 'none';
      }

      // Steps-Section
      const stepsEl = document.getElementById('taskDetailSteps');
      const steps = (details.steps && details.steps.length > 0) ? details.steps : (guidance ? guidance.steps : []);
      if (steps.length > 0) {
        stepsEl.innerHTML = `
          <strong>📋 So gehst du vor:</strong>
          <ol>${steps.map(s => `<li>${s}</li>`).join('')}</ol>
        `;
        stepsEl.style.display = 'block';
      } else {
        stepsEl.style.display = 'none';
      }

      // Button-Status
      const completeBtn = document.getElementById('taskCompleteBtn');
      if (task.completed) {
        completeBtn.textContent = '✓ Bereits erledigt';
        completeBtn.disabled = true;
        completeBtn.style.opacity = '0.5';
      } else {
        completeBtn.textContent = '✓ Erledigt';
        completeBtn.disabled = false;
        completeBtn.style.opacity = '1';
      }

      showScreen('taskDetailScreen', 'forward');
    }

    function startTask() {
      showToast('Los geht\'s! Du schaffst das! 💪', 'success', 2000);
    }

    async function completeTaskFromDetail() {
      if (!currentTaskDetail) return;

      const btn = document.getElementById('taskCompleteBtn');
      btn.disabled = true;
      btn.textContent = 'Wird gespeichert...';

      // Task als erledigt markieren
      await toggleTask(currentTaskDetail.id, true);

      // Update local state
      if (currentTaskDetail) {
        currentTaskDetail.completed = true;
      }

      // Kurze Erfolgsmeldung
      showToast('Aufgabe erledigt! 🎉', 'success', 2000);

      // Zurück zur vorherigen Seite
      setTimeout(() => {
        showScreen(taskDetailPreviousScreen, 'back');
        currentTaskDetail = null;
      }, 500);
    }

    function goBackFromTaskDetail() {
      showScreen(taskDetailPreviousScreen, 'back');
      currentTaskDetail = null;
    }

    // Aktualisiert alle Fortschrittsanzeigen für Tasks
    function updateTaskProgress(delta) {
      // Hole aktuelle Werte aus dem DOM
      const tasksValueEl = document.getElementById('tasksValue');
      const tasksPercentEl = document.getElementById('tasksPercent');
      const tasksRingEl = document.getElementById('tasksRing');
      const tasksCompletedEl = document.getElementById('tasksCompletedValue');
      const tasksBadgeEl = document.getElementById('tasksBadge');

      if (!tasksValueEl) return;

      // Parse aktuelle Werte "X/Y"
      const currentValue = tasksValueEl.textContent || '0/0';
      const [completedStr, totalStr] = currentValue.split('/');
      let completed = parseInt(completedStr) || 0;
      const total = parseInt(totalStr) || 0;

      // Aktualisiere
      completed = Math.max(0, Math.min(total, completed + delta));
      const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
      const offset = 283 - (283 * percent / 100);

      // Update DOM
      if (tasksValueEl) tasksValueEl.textContent = `${completed}/${total}`;
      if (tasksPercentEl) tasksPercentEl.textContent = `${percent}%`;
      if (tasksRingEl) tasksRingEl.style.strokeDashoffset = offset;
      if (tasksCompletedEl) tasksCompletedEl.textContent = completed;
      if (tasksBadgeEl) tasksBadgeEl.textContent = `${completed}/${total}`;

      // Animation für den Ring
      if (tasksRingEl) {
        tasksRingEl.style.transition = 'stroke-dashoffset 0.5s ease-out';
      }
    }

    async function deleteTask(taskId, skipUndo = false) {
      const UNDO_TIMEOUT = 8000; // 8 Sekunden für Undo

      // Task-Element finden
      const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
      const taskText = taskEl?.querySelector('.task-text, .progress-task-text')?.textContent || 'Aufgabe';

      // Visuell ausblenden
      if (taskEl) {
        taskEl.style.transition = 'all 0.3s';
        taskEl.style.transform = 'translateX(100%)';
        taskEl.style.opacity = '0';
        taskEl.style.pointerEvents = 'none';
        taskEl.dataset.deleted = 'true';
      }

      // Pending-Deletion tracken
      const deletionId = `del_${taskId}_${Date.now()}`;
      const deleteTimeout = setTimeout(async () => {
        // Hard-Delete nach Timeout
        pendingDeletions.delete(deletionId);
        const result = await apiCall('/functions/v1/task-update', {
          method: 'POST',
          body: { task_id: taskId, action: 'delete' }
        });

        if (result.success && taskEl) {
          taskEl.remove();
        } else if (!result.success) {
          // Bei Fehler wiederherstellen
          undoDeleteTask(taskId, taskEl);
          showToast('Fehler beim Löschen', 'error');
        }
      }, UNDO_TIMEOUT);

      pendingDeletions.set(deletionId, {
        taskId,
        taskEl,
        timeoutId: deleteTimeout,
        taskText
      });

      // Undo-Toast anzeigen
      if (!skipUndo) {
        showToast('Aufgabe gelöscht', 'info', UNDO_TIMEOUT, {
          label: 'Rückgängig',
          callback: () => {
            undoDeleteTask(taskId, taskEl, deletionId);
          }
        });
      }
    }

    function undoDeleteTask(taskId, taskEl, deletionId) {
      // Deletion abbrechen
      if (deletionId && pendingDeletions.has(deletionId)) {
        const deletion = pendingDeletions.get(deletionId);
        clearTimeout(deletion.timeoutId);
        pendingDeletions.delete(deletionId);
      }

      // Task visuell wiederherstellen
      if (taskEl) {
        taskEl.style.transition = 'all 0.3s';
        taskEl.style.transform = 'translateX(0)';
        taskEl.style.opacity = '1';
        taskEl.style.pointerEvents = 'auto';
        delete taskEl.dataset.deleted;
      }

      showToast('Aufgabe wiederhergestellt', 'success', 2000);
    }

    function editGoals() {
      setupGoalsScreen();
      showScreen('goalsScreen');
    }

    // Profile Screen
    let profileData = {};

    function showProfileScreen() {
      previousScreen = document.querySelector('.screen.active')?.id || 'dashboardScreen';
      loadProfile();
      updateThemeToggleUI();
      showScreen('profileScreen', 'forward');
    }

    function closeProfileScreen() {
      showScreen(previousScreen || 'dashboardScreen', 'back');
    }

    async function loadProfile() {
      const result = await apiCall('/functions/v1/auth-profile', { method: 'GET' });
      if (result.success && result.data?.profile) {
        const profile = result.data.profile;
        profileData = profile;

        // Felder füllen
        document.getElementById('profileAge').value = profile.age || '';
        document.getElementById('profileJob').value = profile.job || '';
        document.getElementById('profileEducation').value = profile.education || '';
        document.getElementById('profileFamily').value = profile.family_status || '';
        document.getElementById('profileHobbies').value = profile.hobbies || '';
        document.getElementById('profileStrengths').value = profile.strengths || '';
        document.getElementById('profileChallenges').value = profile.challenges || '';
        document.getElementById('profileMotivation').value = profile.motivation || '';

        // Profil-Vollständigkeit berechnen
        updateProfileCompletion();
      }

      // Event-Listener für Echtzeit-Update der Vollständigkeit
      const profileFields = ['profileAge', 'profileJob', 'profileEducation', 'profileFamily',
                            'profileHobbies', 'profileStrengths', 'profileChallenges', 'profileMotivation'];
      profileFields.forEach(fieldId => {
        const el = document.getElementById(fieldId);
        if (el) {
          el.removeEventListener('input', updateProfileCompletion);
          el.removeEventListener('change', updateProfileCompletion);
          el.addEventListener('input', updateProfileCompletion);
          el.addEventListener('change', updateProfileCompletion);
        }
      });
    }

    function updateProfileCompletion() {
      const fields = [
        { id: 'profileAge', weight: 1 },
        { id: 'profileJob', weight: 1.5 },
        { id: 'profileEducation', weight: 1 },
        { id: 'profileFamily', weight: 1 },
        { id: 'profileHobbies', weight: 1.5 },
        { id: 'profileStrengths', weight: 1.5 },
        { id: 'profileChallenges', weight: 1.5 },
        { id: 'profileMotivation', weight: 1 }
      ];

      let filled = 0;
      let total = 0;
      let emptyFields = [];

      fields.forEach(field => {
        total += field.weight;
        const el = document.getElementById(field.id);
        const value = el?.value?.trim();
        if (value && value !== '') {
          filled += field.weight;
        } else {
          emptyFields.push(field.id);
        }
      });

      const percent = Math.round((filled / total) * 100);

      // Ring aktualisieren
      const ringFill = document.getElementById('profileRingFill');
      const ringText = document.getElementById('profileRingText');
      const hint = document.getElementById('profileCompletionHint');

      if (ringFill) {
        ringFill.style.strokeDasharray = `${percent}, 100`;
        if (percent === 100) {
          ringFill.classList.add('complete');
        } else {
          ringFill.classList.remove('complete');
        }
      }

      if (ringText) {
        ringText.textContent = `${percent}%`;
      }

      if (hint) {
        if (percent === 100) {
          hint.textContent = 'Profil vollständig - Die AI kann dich optimal unterstützen!';
          hint.classList.add('complete');
        } else if (percent >= 75) {
          hint.textContent = 'Fast geschafft! Noch wenige Felder für optimale Empfehlungen.';
          hint.classList.remove('complete');
        } else if (percent >= 50) {
          hint.textContent = 'Gut! Je mehr du ausfüllst, desto besser die Empfehlungen.';
          hint.classList.remove('complete');
        } else {
          hint.textContent = 'Vervollständige dein Profil für bessere Empfehlungen';
          hint.classList.remove('complete');
        }
        hint.classList.remove('hidden');
      }
    }

    async function saveProfile() {
      const btn = document.getElementById('profileSaveBtn');
      btn.disabled = true;
      btn.textContent = 'Speichern...';

      const profileUpdate = {
        age: parseInt(document.getElementById('profileAge').value) || null,
        job: document.getElementById('profileJob').value || null,
        education: document.getElementById('profileEducation').value || null,
        family_status: document.getElementById('profileFamily').value || null,
        hobbies: document.getElementById('profileHobbies').value || null,
        strengths: document.getElementById('profileStrengths').value || null,
        challenges: document.getElementById('profileChallenges').value || null,
        motivation: document.getElementById('profileMotivation').value || null
      };

      const result = await apiCall('/functions/v1/auth-profile', {
        method: 'POST',
        body: profileUpdate
      });

      btn.disabled = false;
      btn.textContent = 'Profil speichern';

      if (result.success) {
        showToast('Profil gespeichert!', 'success');
        closeProfileScreen();
      } else {
        showToast('Fehler beim Speichern: ' + (result.error || 'Unbekannter Fehler'), 'error');
      }
    }

    // Review
    function setupReviewScreen(tasks) {
      reviewData = tasks.map(t => ({ task_id: t.id, completed: null, blockers: [] }));

      const container = document.getElementById('reviewTasks');
      container.innerHTML = tasks.map((task, idx) => `
        <div class="card" data-task-idx="${idx}">
          <div style="font-weight: 500; margin-bottom: 12px;">${task.task_text}</div>
          <div class="review-buttons">
            <button class="review-btn" onclick="setReview(${idx}, true)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Geschafft</button>
            <button class="review-btn" onclick="setReview(${idx}, false)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> Nicht geschafft</button>
          </div>
          <div class="blocker-input" id="blocker-${idx}">
            <input type="text" class="form-input" placeholder="Was hat dich gehindert?"
                   onchange="setBlocker(${idx}, this.value)" style="margin-top: 12px;">
          </div>
        </div>
      `).join('');
    }

    function setReview(idx, completed) {
      reviewData[idx].completed = completed;

      const card = document.querySelector(`[data-task-idx="${idx}"]`);
      const buttons = card.querySelectorAll('.review-btn');
      buttons[0].className = `review-btn ${completed ? 'selected-yes' : ''}`;
      buttons[1].className = `review-btn ${!completed ? 'selected-no' : ''}`;

      // Show blocker input if not completed
      document.getElementById(`blocker-${idx}`).classList.toggle('show', !completed);

      updateReviewButton();
    }

    function setBlocker(idx, value) {
      reviewData[idx].blockers = value ? [value] : [];
    }

    function updateReviewButton() {
      const allReviewed = reviewData.every(r => r.completed !== null);
      document.getElementById('reviewSubmit').disabled = !allReviewed;
    }

    async function submitReview() {
      const btn = document.getElementById('reviewSubmit');
      btn.disabled = true;
      btn.textContent = 'Wird verarbeitet...';

      const result = await apiCall('/functions/v1/daily-review', {
        method: 'POST',
        body: { reviews: reviewData }
      });

      if (result.success) {
        loadDailyStart();
      } else {
        btn.disabled = false;
        btn.textContent = 'Weiter';
        showToast('Fehler: ' + (result.error || 'Unbekannter Fehler'), 'error');
      }
    }

    // Progress Screen Functions
    let progressScreenPreviousScreen = 'dashboardScreen';
    let currentActiveScreen = 'dashboardScreen';

    async function showProgressScreen() {
      // Save current screen before switching
      const activeScreen = document.querySelector('.screen.active');
      if (activeScreen && activeScreen.id !== 'progressScreen') {
        progressScreenPreviousScreen = activeScreen.id;
      }
      showScreen('progressScreen', 'forward');

      // Show motivation quote if pending from check-in
      if (pendingMotivationMood) {
        setTimeout(() => {
          showMotivationQuote(pendingMotivationMood, true);
          pendingMotivationMood = null; // Reset after showing
        }, 800);
      }

      // Set today's date
      const today = new Date();
      document.getElementById('progressDate').textContent = today.toLocaleDateString('de-DE', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
      });

      // Load fresh data
      const result = await apiCall('/functions/v1/daily-start', { method: 'POST' });

      if (result.success) {
        updateProgressScreen(result.data.data);
      }
    }

    function closeProgressScreen() {
      // Go back to previous screen, default to dashboard
      const targetScreen = progressScreenPreviousScreen || lastActiveScreen || 'dashboardScreen';
      // Don't go back to loading or progress screen
      if (targetScreen === 'loadingScreen' || targetScreen === 'progressScreen') {
        showScreen('dashboardScreen', 'back');
      } else {
        showScreen(targetScreen, 'back');
      }
    }

    function startNewGoal() {
      setupGoalsScreen();
      showScreen('goalsScreen', 'forward');
    }

    function showCheckinScreen() {
      showScreen('checkinScreen', 'forward');
    }

    function updateProgressScreen(data) {
      // Mood - Verwende Daten aus API (today_checkin) oder lokale checkinData
      const moodData = {
        great: { emoji: '😊', text: 'Super', class: 'mood-great', mouth: 'M20 40 Q32 54, 44 40' },
        good: { emoji: '🙂', text: 'Gut', class: 'mood-good', mouth: 'M20 42 Q32 50, 44 42' },
        neutral: { emoji: '😐', text: 'Okay', class: 'mood-neutral', mouth: 'M22 44 L42 44' },
        bad: { emoji: '😔', text: 'Nicht so gut', class: 'mood-bad', mouth: 'M22 46 Q32 42, 42 46' },
        terrible: { emoji: '😢', text: 'Schlecht', class: 'mood-terrible', mouth: 'M22 48 Q32 38, 42 48' }
      };

      // Get today's checkin mood from API data, fallback to local checkinData
      const todayCheckin = data.today_checkin || {};
      const todayMood = todayCheckin.mood || checkinData.mood || 'neutral';
      const mood = moodData[todayMood] || moodData.neutral;

      document.getElementById('moodEmoji').textContent = mood.emoji;
      document.getElementById('moodValue').textContent = mood.text;
      document.getElementById('moodValue').className = `stat-value ${mood.class}`;

      // Update animated mood face
      const moodFace = document.getElementById('moodFace');
      const faceMouth = document.getElementById('faceMouth');
      if (moodFace) {
        moodFace.className = `mood-face ${todayMood}`;
      }
      if (faceMouth && mood.mouth) {
        faceMouth.setAttribute('d', mood.mouth);
      }

      // Energy - Verwende Daten aus API oder lokale checkinData
      const energyLevel = todayCheckin.energy_level || checkinData.energy_level || 3;
      const energyPercent = (energyLevel / 5) * 100;
      const energyOffset = 283 - (283 * energyPercent / 100);

      document.getElementById('energyValue').textContent = energyLevel;
      document.getElementById('energyRing').style.strokeDashoffset = energyOffset;

      const energyTexts = ['', 'Sehr niedrig', 'Niedrig', 'Mittel', 'Hoch', 'Sehr hoch'];
      document.getElementById('energyText').textContent = energyTexts[energyLevel] || 'Mittel';

      // Aktualisiere auch die lokale checkinData für Konsistenz
      if (todayCheckin.mood) checkinData.mood = todayCheckin.mood;
      if (todayCheckin.energy_level) checkinData.energy_level = todayCheckin.energy_level;

      // Tasks Progress
      const tasks = data.today_tasks || [];
      const completedTasks = tasks.filter(t => t.completed).length;
      const totalTasks = tasks.length;
      const tasksPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      const tasksOffset = 283 - (283 * tasksPercent / 100);

      document.getElementById('tasksPercent').textContent = `${tasksPercent}%`;
      document.getElementById('tasksRing').style.strokeDashoffset = tasksOffset;
      document.getElementById('tasksValue').textContent = `${completedTasks}/${totalTasks}`;

      // Stats
      document.getElementById('streakValue').textContent = data.streak || 0;
      document.getElementById('tasksCompletedValue').textContent = completedTasks;

      const goalsActive = (data.longterm_goals || []).filter(g => g.status === 'in_progress').length;
      document.getElementById('goalsActiveValue').textContent = goalsActive || (data.longterm_goals || []).length;

      // Average Progress
      const goalsWithProgress = (data.longterm_goals || []).filter(g => g.progress_percent !== null);
      const avgProgress = goalsWithProgress.length > 0
        ? Math.round(goalsWithProgress.reduce((sum, g) => sum + (g.progress_percent || 0), 0) / goalsWithProgress.length)
        : 0;
      document.getElementById('avgProgressValue').textContent = `${avgProgress}%`;

      // Today's Tasks List
      document.getElementById('todayTasksCount').textContent = `${totalTasks} Aufgaben`;
      const tasksContainer = document.getElementById('progressTodayTasks');

      if (tasks.length === 0) {
        tasksContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
            <div class="empty-state-title">Zeit für neue Ziele!</div>
            <p>Erstelle ein Ziel, um automatisch tägliche Aufgaben zu erhalten.</p>
            <button class="empty-state-btn" onclick="closeProgressScreen(); editGoals();">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Ziel erstellen
            </button>
          </div>
        `;
      } else {
        tasksContainer.innerHTML = tasks.map(task => {
          const details = task.task_details || {};
          const timeIcon = {'morgens': '🌅', 'mittags': '☀️', 'abends': '🌙'}[details.best_time] || '';
          const timeLabel = details.best_time ? details.best_time.charAt(0).toUpperCase() + details.best_time.slice(1) : '';
          const duration = task.estimated_minutes || 15;
          return `
          <div class="progress-task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" onclick="showTaskDetail('${task.id}')">
            <div class="progress-task-checkbox">${task.completed ? '✓' : ''}</div>
            <div class="task-content">
              <div class="progress-task-text">${task.task_text}</div>
              <div class="task-meta">
                <span class="task-meta-item">⏱️ ${duration} Min</span>
                ${timeIcon ? `<span class="task-meta-item">${timeIcon} ${timeLabel}</span>` : ''}
              </div>
            </div>
            <div class="task-arrow">›</div>
          </div>
        `}).join('');
      }
    }

    // ===== TAG SYSTEM =====

    // Verfügbare Tag-Farben
    const tagColors = ['blue', 'green', 'red', 'yellow', 'purple', 'cyan'];
    let selectedTagColor = 'blue';
    let activeTagFilter = null;

    // Tag zu einem Goal hinzufügen (Frontend-only, API-Integration später)
    async function addTagToGoal(goalId, tagName, color = 'blue') {
      if (!tagName || tagName.trim().length === 0) return;

      tagName = tagName.trim().toLowerCase().slice(0, 30);

      // Optimistic UI Update
      const goal = goalsOverviewData.find(g => g.id === goalId);
      if (goal) {
        if (!goal.tags) goal.tags = [];
        if (goal.tags.length >= 5) {
          showToast('Maximum 5 Tags pro Ziel erlaubt', 'warning');
          return;
        }
        if (goal.tags.some(t => t.tag === tagName)) {
          showToast('Tag existiert bereits', 'info');
          return;
        }
        goal.tags.push({ tag: tagName, color });
        renderGoalsOverview();
        showToast(`Tag "${tagName}" hinzugefügt`, 'success', 1500);
      }

      // TODO: API-Call zum Speichern
      // await apiCall('/functions/v1/goal-tags', { method: 'POST', body: { goal_id: goalId, tag: tagName, color } });
    }

    // Tag von einem Goal entfernen
    async function removeTagFromGoal(goalId, tagName) {
      const goal = goalsOverviewData.find(g => g.id === goalId);
      if (goal && goal.tags) {
        goal.tags = goal.tags.filter(t => t.tag !== tagName);
        renderGoalsOverview();
        showToast('Tag entfernt', 'info', 1500);
      }

      // TODO: API-Call zum Löschen
    }

    // Filter Goals nach Tag
    function filterByTag(tag) {
      if (activeTagFilter === tag) {
        activeTagFilter = null;
      } else {
        activeTagFilter = tag;
      }
      renderGoalsOverview();
    }

    // Alle verwendeten Tags sammeln
    function getAllUsedTags() {
      const tags = new Map();
      (goalsOverviewData || []).forEach(goal => {
        (goal.tags || []).forEach(t => {
          if (!tags.has(t.tag)) {
            tags.set(t.tag, { tag: t.tag, color: t.color, count: 1 });
          } else {
            tags.get(t.tag).count++;
          }
        });
      });
      return Array.from(tags.values()).sort((a, b) => b.count - a.count);
    }

    // Tag-Filter UI rendern
    function renderTagFilters() {
      const usedTags = getAllUsedTags();
      if (usedTags.length === 0) return '';

      const filterButtons = usedTags.map(t => `
        <button class="tag-filter-btn ${activeTagFilter === t.tag ? 'active' : ''}"
                onclick="filterByTag('${t.tag}')">
          #${t.tag} (${t.count})
        </button>
      `).join('');

      return `
        <div class="tag-filter-container">
          <button class="tag-filter-btn ${!activeTagFilter ? 'active' : ''}"
                  onclick="filterByTag(null)">
            Alle
          </button>
          ${filterButtons}
        </div>
      `;
    }

    // Tags für ein Goal als HTML rendern
    function renderGoalTags(goal, editable = false) {
      const tags = goal.tags || [];
      if (tags.length === 0 && !editable) return '';

      const tagsHtml = tags.map(t => `
        <span class="goal-tag tag-${t.color}">
          #${t.tag}
          ${editable ? `<button class="goal-tag-remove" onclick="event.stopPropagation(); removeTagFromGoal('${goal.id}', '${t.tag}')">&times;</button>` : ''}
        </span>
      `).join('');

      return `<div class="goal-tags">${tagsHtml}</div>`;
    }

    // Tag-Farbe auswählen
    function selectTagColor(color) {
      selectedTagColor = color;
      document.querySelectorAll('.tag-color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === color);
      });
    }

    // Goals Overview Functions
    let goalsOverviewData = [];
    let goalsOverviewPreviousScreen = 'dashboardScreen';

    async function showGoalsOverview() {
      // Get CURRENT active screen, not lastActiveScreen
      const currentActive = document.querySelector('.screen.active');
      goalsOverviewPreviousScreen = currentActive?.id || 'dashboardScreen';
      showScreen('goalsOverviewScreen', 'forward');

      // Load goals data
      const result = await apiCall('/functions/v1/daily-start', { method: 'POST' });

      if (result.success) {
        goalsOverviewData = result.data.data?.longterm_goals || [];
        renderGoalsOverview();
      } else {
        goalsOverviewData = [];
        renderGoalsOverview();
      }
    }

    function renderGoalsOverview() {
      const container = document.getElementById('goalsOverviewList');
      // Store in window for onclick access
      window.goalsOverviewData = goalsOverviewData;

      if (goalsOverviewData.length === 0) {
        container.innerHTML = `
          <div class="card">
            <div class="empty-state">
              <div class="empty-state-icon">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="6"/>
                  <circle cx="12" cy="12" r="2"/>
                </svg>
              </div>
              <div class="empty-state-title">Deine Ziele warten auf dich!</div>
              <p>Jedes große Projekt beginnt mit einem klaren Ziel. Was möchtest du erreichen?</p>
              <button class="empty-state-btn" onclick="startNewGoal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Ziel definieren
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Tag-Filter rendern
      const tagFiltersHtml = renderTagFilters();

      // Goals filtern wenn ein Tag ausgewählt ist
      let filteredGoals = goalsOverviewData;
      if (activeTagFilter) {
        filteredGoals = goalsOverviewData.filter(g =>
          (g.tags || []).some(t => t.tag === activeTagFilter)
        );
      }

      // Index im Original-Array statt im gefilterten Array verwenden
      const goalsHtml = filteredGoals.map((goal) => {
        const idx = goalsOverviewData.indexOf(goal);
        const progress = goal.progress_percent || 0;
        const daysLeft = goal.days_left;
        const targetDate = goal.target_date
          ? new Date(goal.target_date).toLocaleDateString('de-DE', { day: 'numeric', month: 'short' })
          : '';
        const statusClass = goal.status === 'in_progress' ? '' : 'open';
        const statusText = goal.status === 'in_progress' ? 'Aktiv' : (goal.status === 'achieved' ? 'Erreicht' : 'Offen');

        return `
          <div class="goal-overview-card" onclick="showGoalDetailFromOverview(${idx})">
            <div class="goal-overview-header">
              <div class="goal-overview-title">${goal.title}</div>
              <div class="goal-overview-status ${statusClass}">${statusText}</div>
            </div>
            <div class="goal-overview-meta">
              ${daysLeft !== null ? `
                <div class="goal-overview-meta-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  ${daysLeft} Tage übrig
                </div>
              ` : ''}
              ${targetDate ? `
                <div class="goal-overview-meta-item">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  Ziel: ${targetDate}
                </div>
              ` : ''}
            </div>
            <div class="goal-overview-progress">
              <div class="goal-overview-progress-fill" style="width: ${progress}%"></div>
            </div>
            ${renderGoalTags(goal)}
          </div>
        `;
      }).join('');

      // Alles zusammenfügen
      container.innerHTML = tagFiltersHtml + goalsHtml;
    }

    // Make function globally available for onclick
    window.showGoalDetailFromOverview = function(idx) {
      console.log('showGoalDetailFromOverview called with idx:', idx);
      const data = window.goalsOverviewData || goalsOverviewData;
      console.log('goalsOverviewData length:', data?.length);
      const goal = data[idx];
      console.log('Selected goal:', goal);
      if (goal) {
        showGoalDetail(goal);
      } else {
        console.error('Goal not found at index:', idx);
      }
    };

    function closeGoalsOverview() {
      showScreen(goalsOverviewPreviousScreen, 'back');
    }

    // Achieved Goals Functions
    let achievedGoalsData = [];

    async function showAchievedGoalsScreen() {
      showScreen('achievedGoalsScreen', 'forward');

      // Load goals data
      const result = await apiCall('/functions/v1/daily-start', { method: 'POST' });

      if (result.success) {
        // Filter for achieved goals only (status === 'achieved')
        const allGoals = result.data.data?.longterm_goals || [];
        achievedGoalsData = allGoals.filter(g => g.status === 'achieved');
        renderAchievedGoals();
      } else {
        achievedGoalsData = [];
        renderAchievedGoals();
      }
    }

    function renderAchievedGoals() {
      const container = document.getElementById('achievedGoalsList');
      window.achievedGoalsData = achievedGoalsData;

      if (achievedGoalsData.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = achievedGoalsData.map((goal, idx) => {
        const plan = goal.plan_json || {};
        const durationWeeks = plan.duration_weeks || 0;
        const dailyTasks = plan.daily_tasks || [];
        const milestones = plan.milestones || [];

        // Calculate time spent (from created_at to updated_at or now)
        const createdDate = new Date(goal.created_at);
        const completedDate = goal.updated_at ? new Date(goal.updated_at) : new Date();
        const daysTaken = Math.ceil((completedDate - createdDate) / (1000 * 60 * 60 * 24));
        const weeksTaken = Math.ceil(daysTaken / 7);

        // Format dates
        const completedFormatted = completedDate.toLocaleDateString('de-DE', {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        });

        // Get first 3 daily tasks for preview
        const taskPreview = dailyTasks.slice(0, 3);

        return `
          <div class="achieved-goal-card" onclick="showAchievedGoalDetail(${idx})">
            <div class="achieved-goal-header">
              <div class="achieved-goal-title">${goal.title}</div>
              <div class="achieved-goal-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
                Erreicht
              </div>
            </div>

            <div class="achieved-goal-stats">
              <div class="achieved-stat">
                <div class="achieved-stat-value">${weeksTaken}</div>
                <div class="achieved-stat-label">Wochen</div>
              </div>
              <div class="achieved-stat">
                <div class="achieved-stat-value">${milestones.length}</div>
                <div class="achieved-stat-label">Meilensteine</div>
              </div>
              <div class="achieved-stat">
                <div class="achieved-stat-value">${dailyTasks.length}</div>
                <div class="achieved-stat-label">Aufgaben</div>
              </div>
            </div>

            ${taskPreview.length > 0 ? `
              <div class="achieved-goal-plan">
                <div class="achieved-plan-title">Tägliche Aufgaben</div>
                <div class="achieved-plan-tasks">
                  ${taskPreview.map(task => `
                    <div class="achieved-plan-task">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M20 6L9 17l-5-5"/>
                      </svg>
                      ${typeof task === 'string' ? task : task.task}
                    </div>
                  `).join('')}
                  ${dailyTasks.length > 3 ? `
                    <div class="achieved-plan-task" style="color: var(--text-muted);">
                      +${dailyTasks.length - 3} weitere Aufgaben
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}

            <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
              Erreicht am ${completedFormatted}
            </div>
          </div>
        `;
      }).join('');
    }

    function showAchievedGoalDetail(idx) {
      const goal = window.achievedGoalsData[idx];
      if (!goal) return;

      // Use existing goal detail screen to show the achieved goal
      currentGoalDetail = goal;
      goalDetailPreviousScreen = 'achievedGoalsScreen';
      showGoalDetail(idx, window.achievedGoalsData);
    }

    // Goal Detail Functions
    let goalDetailPreviousScreen = 'dashboardScreen';

    function closeGoalDetail() {
      showScreen(goalDetailPreviousScreen, 'back');
    }

    function confirmDeleteGoal() {
      if (!currentGoalDetail) return;

      const goalTitle = currentGoalDetail.title;
      const confirmed = confirm(
        `Bist du sicher, dass du das Ziel "${goalTitle}" löschen möchtest?\n\n` +
        `Alle zugehörigen Aufgaben und Pläne werden ebenfalls gelöscht.\n\n` +
        `Diese Aktion kann nicht rückgängig gemacht werden.`
      );

      if (confirmed) {
        deleteGoal(currentGoalDetail.id);
      }
    }

    async function regeneratePlan(goalId) {
      const btn = document.querySelector('.btn-generate-plan');
      if (!btn) return;

      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Generiere Plan...';
      btn.style.opacity = '0.7';

      try {
        const result = await apiCall('/functions/v1/goal-regenerate-plan', {
          method: 'POST',
          body: { goal_id: goalId },
          timeout: 90000 // 90 Sekunden für AI-Generierung
        });

        if (result.success && result.plan) {
          btn.innerHTML = '✓ Plan erstellt!';
          btn.style.background = 'var(--success, #10b981)';

          // Update currentGoalDetail with the new plan
          if (currentGoalDetail) {
            currentGoalDetail.plan = result.plan;
            currentGoalDetail.target_date = result.plan.target_date;
          }

          // Reload goal detail to show the new plan
          setTimeout(() => {
            loadDailyStart().then(() => {
              // Find the updated goal and show details
              const updatedGoals = appData?.data?.longterm_goals || [];
              const updatedGoal = updatedGoals.find(g => g.id === goalId);
              if (updatedGoal) {
                showGoalDetail(updatedGoal);
              }
            });
          }, 1000);
        } else {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          btn.style.opacity = '1';
          showToast('Fehler: ' + (result.error || 'Plan konnte nicht generiert werden'), 'error');
        }
      } catch (error) {
        console.error('Regenerate plan error:', error);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        btn.style.opacity = '1';
        showToast('Fehler beim Generieren des Plans: ' + error.message, 'error');
      }
    }

    async function deleteGoal(goalId) {
      const btn = document.querySelector('.btn-delete-goal');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Wird gelöscht...';

      try {
        const result = await apiCall('/functions/v1/goal-delete', {
          method: 'POST',
          body: { goal_id: goalId }
        });

        if (result.success) {
          btn.innerHTML = 'Gelöscht!';
          btn.style.borderColor = 'var(--success)';
          btn.style.color = 'var(--success)';

          // Nach kurzer Verzögerung zur Übersicht zurückkehren
          setTimeout(() => {
            // Clear current goal data
            currentGoalDetail = null;
            // Go back to dashboard and reload
            showScreen('dashboardScreen', 'back');
            loadDailyStart();
          }, 800);
        } else {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          showToast('Fehler beim Löschen: ' + (result.error || 'Unbekannter Fehler'), 'error');
        }
      } catch (error) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        showToast('Fehler beim Löschen: ' + error.message, 'error');
      }
    }

    function showGoalDetail(goalData) {
      console.log('showGoalDetail called with:', goalData);
      try {
        // Remember where we came from - get CURRENT active screen, not lastActiveScreen
        const currentActive = document.querySelector('.screen.active');
        goalDetailPreviousScreen = currentActive?.id || 'dashboardScreen';
        console.log('goalDetailPreviousScreen set to:', goalDetailPreviousScreen);
        currentGoalDetail = goalData;

        document.getElementById('goalDetailTitle').textContent = goalData.title;

      // Status Badge
      const statusEl = document.getElementById('goalDetailStatus');
      const statusLabels = {
        'in_progress': 'Aktiv',
        'open': 'Offen',
        'achieved': 'Erreicht',
        'not_achieved': 'Nicht erreicht'
      };
      statusEl.textContent = statusLabels[goalData.status] || goalData.status || 'Offen';
      statusEl.style.background = goalData.status === 'in_progress' ? 'var(--accent-glow)' : 'var(--glass-border)';
      statusEl.style.color = goalData.status === 'in_progress' ? 'var(--accent)' : 'var(--text-muted)';

      // Progress
      const hasProgress = goalData.target_date && goalData.days_left !== null;
      const targetDateStr = goalData.target_date
        ? new Date(goalData.target_date).toLocaleDateString('de-DE', { day: 'numeric', month: 'long', year: 'numeric' })
        : '';

      document.getElementById('goalDetailProgress').innerHTML = hasProgress ? `
        <div class="progress-container">
          <div class="progress-label">
            <span>${goalData.progress_percent || 0}% geschafft</span>
            <span>Ziel: ${targetDateStr}</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" style="width: ${goalData.progress_percent || 0}%"></div>
          </div>
        </div>
        <div class="goal-days-left" style="margin-top: 8px;">
          ${goalData.days_left === 0
            ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg> Heute ist der Zieltag!'
            : goalData.days_left === 1
              ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Noch 1 Tag übrig'
              : `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Noch ${goalData.days_left} Tage übrig`}
        </div>
      ` : `
        <div class="progress-container">
          <div class="progress-label">
            <span>Kein Zeitrahmen festgelegt</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      `;

      // Info Section
      const plan = goalData.plan;
      document.getElementById('goalDetailInfo').innerHTML = `
        <div class="goal-detail-section">
          <div class="goal-detail-section-title">Informationen</div>
          ${plan?.success_metric ? `
            <div class="goal-info-item">
              <div class="goal-info-label">Erfolgskriterium</div>
              <div class="goal-info-value" style="color: var(--accent); font-weight: 500;">${plan.success_metric}</div>
            </div>
          ` : ''}
          ${plan?.duration_weeks ? `
            <div class="goal-info-item">
              <div class="goal-info-label">Zeitrahmen</div>
              <div class="goal-info-value">${plan.duration_weeks} Wochen</div>
            </div>
          ` : ''}
          <div class="goal-info-item">
            <div class="goal-info-label">Erstellt am</div>
            <div class="goal-info-value">${goalData.created_at ? new Date(goalData.created_at).toLocaleDateString('de-DE') : 'Unbekannt'}</div>
          </div>
        </div>
      `;

      // Milestones
      const milestones = plan?.milestones || [];
      if (milestones.length > 0) {
        // Calculate which milestones are completed based on progress
        const progressWeeks = plan?.duration_weeks
          ? Math.floor((goalData.progress_percent / 100) * plan.duration_weeks)
          : 0;

        document.getElementById('goalDetailMilestones').innerHTML = `
          <div class="goal-detail-section">
            <div class="goal-detail-section-title">Meilensteine</div>
            ${milestones.map((m, idx) => {
              const isCompleted = m.week <= progressWeeks;
              const isCurrent = !isCompleted && (idx === 0 || milestones[idx - 1].week <= progressWeeks);
              return `
                <div class="step-item ${isCompleted ? 'completed' : ''}">
                  <div class="step-number">${isCompleted ? '✓' : idx + 1}</div>
                  <div class="step-content">
                    <div class="step-text">${m.target}</div>
                    <div class="step-meta">Woche ${m.week} ${m.metric ? `• ${m.metric}` : ''} ${isCurrent ? '← Aktuell' : ''}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        document.getElementById('goalDetailMilestones').innerHTML = `
          <div class="goal-detail-section">
            <div class="goal-detail-section-title">Meilensteine</div>
            <p style="color: var(--text-muted); font-size: 14px;">Keine Meilensteine definiert.</p>
          </div>
        `;
      }

      // Daily Tasks
      const dailyTasks = plan?.daily_tasks || [];
      const hasPlan = plan && (dailyTasks.length > 0 || milestones.length > 0);

      if (dailyTasks.length > 0) {
        document.getElementById('goalDetailTasks').innerHTML = `
          <div class="goal-detail-section">
            <div class="goal-detail-section-title">Tägliche Aufgaben</div>
            ${dailyTasks.map((t, idx) => `
              <div class="daily-task-item-detailed">
                <div class="task-header">
                  <div class="task-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>
                  <div class="task-info">
                    <div class="task-name">${t.task}</div>
                    <div class="task-meta">
                      <span class="task-duration">${t.duration_minutes} Min.</span>
                      <span class="task-time">${t.best_time ? (t.best_time === 'morgens' ? '🌅 Morgens' : t.best_time === 'mittags' ? '☀️ Mittags' : t.best_time === 'abends' ? '🌙 Abends' : '⏰ Flexibel') : ''}</span>
                    </div>
                  </div>
                </div>
                ${t.why ? `<div class="task-why"><strong>Warum:</strong> ${t.why}</div>` : ''}
                ${t.steps?.length ? `
                <div class="task-steps">
                  <div class="task-steps-title">So geht's:</div>
                  <ol class="task-steps-list">
                    ${t.steps.map(step => `<li>${step}</li>`).join('')}
                  </ol>
                </div>
                ` : ''}
              </div>
            `).join('')}
          </div>

          ${plan?.weekly_tasks?.length ? `
            <div class="goal-detail-section">
              <div class="goal-detail-section-title">Wöchentliche Aufgaben</div>
              ${plan.weekly_tasks.map((t, idx) => `
                <div class="step-item">
                  <div class="step-number">W</div>
                  <div class="step-content">
                    <div class="step-text">${t}</div>
                    <div class="step-meta">Wöchentlich</div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        `;
      } else {
        document.getElementById('goalDetailTasks').innerHTML = `
          <div class="goal-detail-section">
            <div class="goal-detail-section-title">Tägliche Aufgaben</div>
            <p style="color: var(--text-muted); font-size: 14px;">Keine Aufgaben definiert.</p>
            ${!hasPlan ? `
              <button class="btn-generate-plan" onclick="regeneratePlan('${goalData.id}')" style="margin-top: 16px; width: 100%; padding: 14px 20px; background: linear-gradient(135deg, var(--accent), #22d3ee); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"/>
                  <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                  <line x1="9" y1="9" x2="9.01" y2="9"/>
                  <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
                AI-Plan generieren
              </button>
            ` : ''}
          </div>
        `;
      }

      previousScreen = 'dashboardScreen';
      console.log('About to show goalDetailScreen');
      showScreen('goalDetailScreen');
      console.log('showGoalDetail complete');
      } catch (error) {
        console.error('Error in showGoalDetail:', error);
        showToast('Fehler beim Laden der Zieldetails: ' + error.message, 'error');
      }
    }

    // ===== PWA: Service Worker Registration =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('sw.js');
          console.log('[PWA] Service Worker registered:', registration.scope);

          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available
                showUpdateNotification();
              }
            });
          });
        } catch (error) {
          console.error('[PWA] Service Worker registration failed:', error);
        }
      });
    }

    // ===== Offline-Erkennung =====
    let offlineBanner = null;

    function createOfflineBanner() {
      if (offlineBanner) return;

      offlineBanner = document.createElement('div');
      offlineBanner.id = 'offlineBanner';
      offlineBanner.innerHTML = `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
          color: white;
          padding: 12px 20px;
          text-align: center;
          font-size: 14px;
          font-weight: 600;
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        ">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="1" y1="1" x2="23" y2="23"/>
            <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/>
            <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/>
            <path d="M10.71 5.05A16 16 0 0 1 22.58 9"/>
            <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/>
            <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
            <line x1="12" y1="20" x2="12.01" y2="20"/>
          </svg>
          Du bist offline - Einige Funktionen sind eingeschränkt
        </div>
      `;
      document.body.prepend(offlineBanner);
    }

    function removeOfflineBanner() {
      if (offlineBanner) {
        offlineBanner.remove();
        offlineBanner = null;
      }
    }

    function updateOnlineStatus() {
      if (navigator.onLine) {
        removeOfflineBanner();
        console.log('[PWA] Online');
      } else {
        createOfflineBanner();
        console.log('[PWA] Offline');
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // Initial check
    if (!navigator.onLine) {
      createOfflineBanner();
    }

    // ===== Update Notification =====
    function showUpdateNotification() {
      const notification = document.createElement('div');
      notification.innerHTML = `
        <div style="
          position: fixed;
          bottom: 20px;
          left: 20px;
          right: 20px;
          background: var(--bg-card);
          border: 1px solid var(--glass-border);
          border-radius: 16px;
          padding: 16px 20px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
        ">
          <span style="font-size: 14px; color: var(--text);">
            Eine neue Version ist verfügbar!
          </span>
          <button onclick="window.location.reload()" style="
            background: var(--gradient-primary);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
          ">
            Aktualisieren
          </button>
        </div>
      `;
      document.body.appendChild(notification);
    }
  </script>
</body>
</html>
